@model SolarEnergy.ViewModels.CompanyParametersViewModel
@{
    ViewData["Title"] = "Parâmetros da Empresa";
}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">Parâmetros da Empresa</h1>
            <p class="text-muted mb-0">Configure os valores utilizados nos cálculos e simulações</p>
        </div>
    </div>

    <div id="saveSuccessAlert" class="alert alert-success d-none" role="alert">
        Parâmetros salvos com sucesso.
    </div>
    <div id="saveErrorAlert" class="alert alert-danger d-none" role="alert">
        Ocorreu um erro ao salvar os parâmetros. Tente novamente.
    </div>

    <form asp-action="Save" method="post" id="company-parameters-form" class="needs-validation" novalidate>
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="Id" />
        <input type="hidden" asp-for="CompanyId" />

        <partial name="_CompanyParametersFormAdmin" model="Model" />

        <div class="mt-4 d-flex justify-content-end">
            <button type="submit" class="btn btn-primary px-4">
                <i class="fas fa-save me-2"></i>Salvar parâmetros
            </button>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('company-parameters-form');
            const successAlert = document.getElementById('saveSuccessAlert');
            const errorAlert = document.getElementById('saveErrorAlert');

            if (!form) return;

            form.addEventListener('submit', async function (e) {
                e.preventDefault();
                hideAlerts();

                const url = form.getAttribute('action');
                const method = form.getAttribute('method') || 'POST';
                const formData = new FormData(form);

                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: formData
                    });

                    if (!response.ok) {
                        await handleErrorResponse(response);
                        return;
                    }

                    const contentType = response.headers.get('Content-Type') || '';
                    if (contentType.includes('application/json')) {
                        const data = await response.json();
                        if (data && data.success === false) {
                            showError(data.message || 'Erro ao salvar parâmetros.');
                            return;
                        }
                    }

                    showSuccess();
                } catch (err) {
                    showError('Erro ao salvar parâmetros.');
                    console.error(err);
                }
            });

            function hideAlerts() {
                successAlert?.classList.add('d-none');
                errorAlert?.classList.add('d-none');
                if (errorAlert) {
                    errorAlert.textContent = 'Ocorreu um erro ao salvar os parâmetros. Tente novamente.';
                }
            }

            function showSuccess() {
                if (successAlert) {
                    successAlert.classList.remove('d-none');
                }
            }

            function showError(message) {
                if (errorAlert) {
                    errorAlert.textContent = message || 'Erro ao salvar parâmetros.';
                    errorAlert.classList.remove('d-none');
                }
            }

            async function handleErrorResponse(response) {
                const contentType = response.headers.get('Content-Type') || '';
                if (contentType.includes('application/json')) {
                    const data = await response.json();
                    if (data && data.errors) {
                        const messages = Object.values(data.errors)
                            .flat()
                            .join(' ');
                        showError(messages || 'Erro ao salvar parâmetros.');
                        return;
                    }
                }

                showError('Erro ao salvar parâmetros.');
            }
        });
    </script>
}
