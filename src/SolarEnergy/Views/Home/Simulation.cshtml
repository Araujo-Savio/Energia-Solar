@model SolarEnergy.ViewModels.SimulationViewModel
@using System.Globalization
@{
    ViewData["Title"] = "Simulador";
    var isCompanyUser = Model.IsCompanyUser;
}

<div class="solar-page economy-simulator">
    <div class="container-fluid px-4">
        <div class="solar-page-header d-flex flex-wrap justify-content-between align-items-center mb-4">
            <div>
                <h1 class="solar-page-title">Simulador de Economia</h1>
                <p class="solar-page-subtitle mb-0">Combine dados reais de consumo para comparar instalação própria e aluguel de energia.</p>
            </div>
            <div class="text-end">
                <span class="badge bg-status-online mb-2"><i class="fas fa-bolt me-1"></i>Cálculo sob demanda</span>
                <p class="text-muted small mb-0">Informe os parâmetros básicos, depois utilize o botão de cálculo para atualizar a simulação.</p>
            </div>
        </div>

        <!-- Seção: Seleção de Empresa -->
        @if (isCompanyUser)
        {
            <div class="d-flex justify-content-end align-items-center gap-3 flex-wrap mb-3">
                <button type="button"
                        class="btn btn-outline-secondary"
                        id="btnOpenCompanyParametersModal"
                        data-bs-toggle="modal"
                        data-bs-target="#companyParametersModal">
                    ⚙ Editar parâmetros da empresa
                </button>
            </div>
            <div id="companyParametersAlert" class="alert alert-success d-none mb-4" role="alert"></div>
        }
        else
        {
            <div class="solar-card mb-4">
                <form method="get" asp-action="Simulation" class="row g-3 align-items-end">
                    <div class="col-12 col-md-6 col-lg-5">
                        <div class="form-group mb-0">
                            <label class="form-label" for="SelectedCompanyId">Escolha a empresa para simular:</label>
                            <select id="SelectedCompanyId"
                                    name="companyId"
                                    class="form-select"
                                    onchange="this.form.submit()">
                                <option value="">Selecione...</option>
                                @foreach (var company in Model.Companies)
                                {
                                    <option value="@company.Id" selected="@(company.Id == Model.SelectedCompanyId)">@company.Name</option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="col-12 col-md-6 col-lg-7">
                        <p class="text-muted mb-0 small">Selecione uma empresa para visualizar os parâmetros usados no cálculo do simulador.</p>
                    </div>
                </form>
            </div>
        }

        @if (!isCompanyUser)
        {
            <form asp-action="UserSimulator" asp-controller="Simulation" method="post" id="user-simulation-form">
                @Html.AntiForgeryToken()
                <input type="hidden" name="SelectedCompanyId" value="@Model.SelectedCompanyId" />
                <input type="hidden" name="SelectedCompanyName" value="@Model.SelectedCompanyName" />
                <input type="hidden" name="IsCompanyUser" value="@Model.IsCompanyUser" />
                <input type="hidden" asp-for="CompanyParametersJson" />

                @await Html.PartialAsync("_SimulationContent", Model)
            </form>
        }
        else
        {
            @await Html.PartialAsync("_SimulationContent", Model)
        }

@if (isCompanyUser)
{
    <div class="modal fade" id="companyParametersModal" tabindex="-1" aria-labelledby="companyParametersModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <div>
                        <h5 class="modal-title" id="companyParametersModalLabel">Parâmetros da empresa</h5>
                        <p class="text-muted small mb-0">Ajuste abaixo os parâmetros padrão usados no cálculo, de acordo com a política comercial da sua empresa.</p>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <form id="companyParametersForm">
                        @Html.AntiForgeryToken()
                        <div class="company-params-grid metrics-grid">
                            <div>
                                <label class="form-label" for="companyPricePerKwp">Preço do sistema por kWp (R$/kWp)</label>
                                <input id="companyPricePerKwp"
                                       type="number"
                                       min="0"
                                       step="50"
                                       class="form-control"
                                       value="@((Model.CompanyParameters?.SystemPricePerKwp ?? 0).ToString(CultureInfo.InvariantCulture))"
                                       data-company-param="system-price-per-kwp" />
                                <small class="text-muted">Valor usado para calcular o custo de instalação.</small>
                            </div>
                            <div>
                                <label class="form-label" for="companyMaintenancePercent">Manutenção anual (% do investimento)</label>
                                <input id="companyMaintenancePercent"
                                       type="number"
                                       min="0"
                                       max="50"
                                       step="0.1"
                                       class="form-control"
                                       value="@((Model.CompanyParameters?.MaintenancePercent ?? 0).ToString(CultureInfo.InvariantCulture))"
                                       data-company-param="maintenance-percent" />
                                <small class="text-muted">Percentual do investimento aplicado por ano.</small>
                            </div>
                            <div>
                                <label class="form-label" for="companyInstallDiscount">Incentivo / desconto na instalação (%)</label>
                                <input id="companyInstallDiscount"
                                       type="number"
                                       min="0"
                                       max="100"
                                       step="0.1"
                                       class="form-control"
                                       value="@((Model.CompanyParameters?.InstallDiscountPercent ?? 0).ToString(CultureInfo.InvariantCulture))"
                                       data-company-param="install-discount-percent" />
                                <small class="text-muted">Percentual aplicado sobre o valor da instalação.</small>
                            </div>
                            <div>
                                <label class="form-label" for="companyRentalFactor">Fator da mensalidade do aluguel (% da conta)</label>
                                <input id="companyRentalFactor"
                                       type="number"
                                       min="0"
                                       max="100"
                                       step="1"
                                       class="form-control"
                                       value="@((Model.CompanyParameters?.RentalFactorPercent ?? 0).ToString(CultureInfo.InvariantCulture))"
                                       data-company-param="rental-factor-percent" />
                                <small class="text-muted">Fração da conta transformada em mensalidade.</small>
                            </div>
                            <div>
                                <label class="form-label" for="companyRentalMinMonthly">Mensalidade mínima de aluguel (R$)</label>
                                <input id="companyRentalMinMonthly"
                                       type="number"
                                       min="0"
                                       step="10"
                                       class="form-control"
                                       value="@((Model.CompanyParameters?.RentalMinMonthly ?? 0).ToString(CultureInfo.InvariantCulture))"
                                       data-company-param="rental-min-monthly" />
                                <small class="text-muted">Valor mínimo praticado.</small>
                            </div>
                            <div>
                                <label class="form-label" for="companyRentalSetup">Taxa de instalação do aluguel (R$ por kWp ou projeto)</label>
                                <input id="companyRentalSetup"
                                       type="number"
                                       min="0"
                                       step="10"
                                       class="form-control"
                                       value="@((Model.CompanyParameters?.RentalSetupPerKwp ?? 0).ToString(CultureInfo.InvariantCulture))"
                                       data-company-param="rental-setup-per-kwp" />
                                <small class="text-muted">Taxa de setup aplicada ao aluguel.</small>
                            </div>
                            <div>
                                <label class="form-label" for="companyRentalIncrease">Reajuste anual da mensalidade do aluguel (%)</label>
                                <input id="companyRentalIncrease"
                                       type="number"
                                       min="0"
                                       max="50"
                                       step="0.1"
                                       class="form-control"
                                       value="@((Model.CompanyParameters?.RentalAnnualIncreasePercent ?? 0).ToString(CultureInfo.InvariantCulture))"
                                       data-company-param="rental-annual-increase-percent" />
                                <small class="text-muted">Percentual aplicado a cada ano.</small>
                            </div>
                            <div>
                                <label class="form-label" for="companyRentalDiscount">Desconto na conta no modelo de aluguel (%)</label>
                                <input id="companyRentalDiscount"
                                       type="number"
                                       min="0"
                                       max="100"
                                       step="0.1"
                                       class="form-control"
                                       value="@((Model.CompanyParameters?.RentalDiscountPercent ?? 0).ToString(CultureInfo.InvariantCulture))"
                                       data-company-param="rental-discount-percent" />
                                <small class="text-muted">Percentual médio aplicado na fatura.</small>
                            </div>
                            <div>
                                <label class="form-label" for="companyConsumptionPerKwp">Consumo mensal por 1 kWp (kWh/mês por kWp)</label>
                                <input id="companyConsumptionPerKwp"
                                       type="number"
                                       min="0"
                                       step="1"
                                       class="form-control"
                                       value="@((Model.CompanyParameters?.ConsumptionPerKwp ?? 0).ToString(CultureInfo.InvariantCulture))"
                                       data-company-param="consumption-per-kwp" />
                                <small class="text-muted">Conversão usada para dimensionamento.</small>
                            </div>
                            <div>
                                <label class="form-label" for="companyMinSystemSize">Potência mínima do sistema (kWp)</label>
                                <input id="companyMinSystemSize"
                                       type="number"
                                       min="0"
                                       step="0.1"
                                       class="form-control"
                                       value="@((Model.CompanyParameters?.MinSystemSizeKwp ?? 0).ToString(CultureInfo.InvariantCulture))"
                                       data-company-param="min-system-size-kwp" />
                                <small class="text-muted">Limite mínimo da solução ofertada.</small>
                            </div>
                        </div>
                    </form>
                    <div class="alert d-none mt-3" id="companyParametersModalFeedback" role="alert"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-solar-orange" id="btnSaveCompanyParameters">Salvar parâmetros</button>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <!-- Chart.js (sem integrity para não ser bloqueado) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>

    <script>
        // Embutimos o JSON como objeto JS válido para evitar quebras de parse ou escapes de HTML.
        const companyParametersData = @Html.Raw(Model.CompanyParametersJson ?? "null");
        const initialCompanyId = '@(Model.SelectedCompanyId ?? string.Empty)';
        window.companyParameters = null;

        (function () {
            const currencyFormatter = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
            const numberFormatter = new Intl.NumberFormat('pt-BR', { maximumFractionDigits: 1 });
            const percentFormatter = new Intl.NumberFormat('pt-BR', { style: 'percent', minimumFractionDigits: 0, maximumFractionDigits: 1 });

            const simulatorRoot = document.querySelector('[data-simulator-root]');
            const isCompanyUser = simulatorRoot?.dataset.companyUser === 'true';
            const saveCompanyParametersUrl = '@Url.Action("SaveForCurrentCompany", "CompanyParameters")';


            const companyParametersFields = [
                { id: 'companyPricePerKwp', dataKey: 'system-price-per-kwp', pascalKey: 'SystemPricePerKwp', camelKey: 'systemPricePerKwp', legacyKeys: ['PricePerKwp', 'pricePerKwp'] },
                { id: 'companyMaintenancePercent', dataKey: 'maintenance-percent', pascalKey: 'MaintenancePercent', camelKey: 'maintenancePercent' },
                { id: 'companyInstallDiscount', dataKey: 'install-discount-percent', pascalKey: 'InstallDiscountPercent', camelKey: 'installDiscountPercent' },
                { id: 'companyRentalFactor', dataKey: 'rental-factor-percent', pascalKey: 'RentalFactorPercent', camelKey: 'rentalFactorPercent' },
                { id: 'companyRentalMinMonthly', dataKey: 'rental-min-monthly', pascalKey: 'RentalMinMonthly', camelKey: 'rentalMinMonthly' },
                { id: 'companyRentalSetup', dataKey: 'rental-setup-per-kwp', pascalKey: 'RentalSetupPerKwp', camelKey: 'rentalSetupPerKwp' },
                { id: 'companyRentalIncrease', dataKey: 'rental-annual-increase-percent', pascalKey: 'RentalAnnualIncreasePercent', camelKey: 'rentalAnnualIncreasePercent' },
                { id: 'companyRentalDiscount', dataKey: 'rental-discount-percent', pascalKey: 'RentalDiscountPercent', camelKey: 'rentalDiscountPercent' },
                { id: 'companyConsumptionPerKwp', dataKey: 'consumption-per-kwp', pascalKey: 'ConsumptionPerKwp', camelKey: 'consumptionPerKwp' },
                { id: 'companyMinSystemSize', dataKey: 'min-system-size-kwp', pascalKey: 'MinSystemSizeKwp', camelKey: 'minSystemSizeKwp' }
            ];

            const companyParamKeys = companyParametersFields.reduce((acc, field) => {
                acc[field.dataKey] = [field.pascalKey, field.camelKey, ...(field.legacyKeys ?? [])];
                return acc;
            }, {});

            const companyParametersAlert = document.getElementById('companyParametersAlert');
            const companyParametersModalElement = document.getElementById('companyParametersModal');
            const companyParametersForm = document.getElementById('companyParametersForm');
            const companyParametersModalFeedback = document.getElementById('companyParametersModalFeedback');
            const saveCompanyParametersButton = document.getElementById('btnSaveCompanyParameters');
            const companySelect = document.getElementById('SelectedCompanyId');
            const companyParameterElements = Array.from(document.querySelectorAll('[data-company-param]'));
            let companyParametersAlertTimeout;

            function showCompanyParametersAlert(message, type = 'success') {
                if (!companyParametersAlert) return;
                companyParametersAlert.textContent = message;
                companyParametersAlert.classList.remove('d-none', 'alert-success', 'alert-danger');
                companyParametersAlert.classList.add(type === 'error' ? 'alert-danger' : 'alert-success');

                if (companyParametersAlertTimeout) {
                    clearTimeout(companyParametersAlertTimeout);
                }

                companyParametersAlertTimeout = window.setTimeout(() => {
                    companyParametersAlert?.classList.add('d-none');
                }, 4000);
            }

            function setCompanyParametersModalFeedback(message, type = 'danger') {
                if (!companyParametersModalFeedback) return;
                companyParametersModalFeedback.textContent = message;
                companyParametersModalFeedback.classList.remove('d-none', 'alert-success', 'alert-danger');
                companyParametersModalFeedback.classList.add(type === 'success' ? 'alert-success' : 'alert-danger');
            }

            function clearCompanyParametersModalFeedback() {
                if (!companyParametersModalFeedback) return;
                companyParametersModalFeedback.textContent = '';
                companyParametersModalFeedback.classList.add('d-none');
            }

            function getParamValueFromPayload(payload, field) {
                if (!payload || typeof payload !== 'object' || !field) {
                    return null;
                }

                const keysToCheck = [field.pascalKey, field.camelKey, ...(field.legacyKeys ?? [])];

                for (const key of keysToCheck) {
                    if (!key) continue;
                    const value = payload[key];
                    if (value !== undefined && value !== null && Number.isFinite(Number(value))) {
                        return value;
                    }
                }

                return null;
            }

            function looksLikeParametersObject(candidate) {
                if (!candidate || typeof candidate !== 'object') {
                    return false;
                }

                return companyParametersFields.some((field) =>
                    Object.prototype.hasOwnProperty.call(candidate, field.pascalKey)
                    || Object.prototype.hasOwnProperty.call(candidate, field.camelKey)
                );
            }

            function applyCompanyParametersToInputs(params) {
                if (!params) return;

                companyParametersFields.forEach((field) => {
                    const input = document.getElementById(field.id);
                    if (!input) return;

                    const value = getParamValueFromPayload(params, field);
                    const numericValue = Number(value);
                    if (Number.isFinite(numericValue)) {
                        // type="number" precisa de ponto como separador decimal para evitar avisos do navegador.
                        input.value = numericValue.toString();
                    }
                });
            }

            // Atualiza os campos exibidos na seção "Parâmetros da Empresa" conforme a empresa escolhida
            function applyCompanyParametersToDisplay(params) {
                companyParameterElements.forEach((element) => {
                    const key = element.dataset.companyParam;
                    const field = companyParametersFields.find(f => f.dataKey === key);
                    const value = params && field ? getParamValueFromPayload(params, field) : null;
                    const numericValue = Number(value);
                    element.value = Number.isFinite(numericValue) ? numericValue.toString() : '';
                });
            }

            function getCompanyParametersFromData(companyId) {
                if (!companyParametersData || typeof companyParametersData !== 'object') {
                    return null;
                }

                if (companyId) {
                    const normalizedId = companyId.toString();
                    const byId = companyParametersData[normalizedId];
                    if (byId && typeof byId === 'object') {
                        return byId;
                    }
                }

                if (looksLikeParametersObject(companyParametersData)) {
                    return companyParametersData;
                }

                return null;
            }

            const companyParametersJsonInput = document.querySelector('input[name="CompanyParametersJson"]');

            function syncCompanyParametersJsonField(parameters) {
                if (!companyParametersJsonInput) {
                    return;
                }

                if (!parameters) {
                    companyParametersJsonInput.value = "null";
                    return;
                }

                try {
                    companyParametersJsonInput.value = JSON.stringify(parameters);
                } catch {
                    companyParametersJsonInput.value = "null";
                }
            }

            // Busca os parâmetros pelo ID selecionado e injeta nos campos e no objeto usado nos cálculos
            function updateCompanyParameters(companyId) {
                const params = getCompanyParametersFromData(companyId);
                window.companyParameters = params ?? null;
                applyCompanyParametersToDisplay(params ?? null);
                syncCompanyParametersJsonField(params ?? null);
            }

            // Carrega os parâmetros iniciais (empresa logada ou empresa pré-selecionada no filtro).
            updateCompanyParameters(initialCompanyId || null);

            function collectCompanyParametersFromInputs() {
                const payload = {};

                companyParametersFields.forEach((field) => {
                    const input = document.getElementById(field.id);
                    if (!input) {
                        payload[field.camelKey] = 0;
                        return;
                    }

                    const rawValue = parseFloat((input.value || '').toString().replace(',', '.'));
                    payload[field.camelKey] = Number.isFinite(rawValue) ? rawValue : 0;
                });

                return payload;
            }

            function getRequestVerificationToken() {
                if (!companyParametersForm) {
                    return null;
                }

                const tokenInput = companyParametersForm.querySelector('input[name="__RequestVerificationToken"]');
                return tokenInput?.value ?? null;
            }

            function hideCompanyParametersModal() {
                if (!companyParametersModalElement || !window.bootstrap || !bootstrap.Modal) return;
                const modalInstance = bootstrap.Modal.getOrCreateInstance(companyParametersModalElement);
                modalInstance.hide();
            }

            async function handleCompanyParametersSave() {
                if (!isCompanyUser || !saveCompanyParametersButton || !companyParametersForm) {
                    return;
                }

                clearCompanyParametersModalFeedback();

                const token = getRequestVerificationToken();
                if (!token) {
                    setCompanyParametersModalFeedback('Token de verificação não encontrado. Atualize a página e tente novamente.');
                    return;
                }

                const payload = collectCompanyParametersFromInputs();

                saveCompanyParametersButton.setAttribute('disabled', 'disabled');

                try {
                    const response = await fetch(saveCompanyParametersUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': token
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        let errorMessage = 'Erro ao salvar os parâmetros da empresa.';

                        try {
                            const contentType = response.headers.get('content-type') ?? '';
                            if (contentType.includes('application/json')) {
                                const errorJson = await response.json();
                                errorMessage = (errorJson && (errorJson.message || errorJson.error)) || errorMessage;
                            } else {
                                const errorText = await response.text();
                                errorMessage = errorText || errorMessage;
                            }
                        } catch (parseError) {
                            console.error('Falha ao ler resposta de erro ao salvar parâmetros:', parseError);
                        }

                        console.error('Erro ao salvar parâmetros:', response.status, errorMessage);
                        setCompanyParametersModalFeedback(errorMessage, 'danger');
                        return;
                    }

                    const savedParameters = await response.json();
                    window.companyParameters = savedParameters;
                    syncCompanyParametersJsonField(savedParameters);
                    applyCompanyParametersToInputs(savedParameters);
                    hideCompanyParametersModal();
                    showCompanyParametersAlert('Parâmetros da empresa salvos com sucesso.');
                    recalculate();
                } catch (error) {
                    console.error('Erro inesperado ao salvar parâmetros da empresa:', error);
                    const message = error instanceof Error ? error.message : 'Erro inesperado ao salvar.';
                    setCompanyParametersModalFeedback(message, 'danger');
                } finally {
                    saveCompanyParametersButton.removeAttribute('disabled');
                }
            }

            function initializeCompanyParametersModal() {
                if (!isCompanyUser || !companyParametersModalElement || !window.bootstrap || !bootstrap.Modal) {
                    return;
                }

                applyCompanyParametersToInputs(window.companyParameters);

                companyParametersModalElement.addEventListener('show.bs.modal', () => {
                    applyCompanyParametersToInputs(window.companyParameters);
                    clearCompanyParametersModalFeedback();
                });

                if (saveCompanyParametersButton) {
                    saveCompanyParametersButton.addEventListener('click', handleCompanyParametersSave);
                }
            }

            initializeCompanyParametersModal();

            // Evento de mudança do select de empresa para carregar os parâmetros correspondentes
            if (companySelect) {
                companySelect.addEventListener('change', function () {
                    updateCompanyParameters(this.value);
                });

                if (companySelect.value) {
                    updateCompanyParameters(companySelect.value);
                }
            }

            const outputs = {
                baseTotal: document.querySelector('[data-sim-output="base-total"]'),
                installTotal: document.querySelector('[data-sim-output="install-total"]'),
                rentalTotal: document.querySelector('[data-sim-output="rental-total"]'),
                installSavings: document.querySelector('[data-sim-output="install-savings"]'),
                rentalSavings: document.querySelector('[data-sim-output="rental-savings"]'),
                installMonthlySavings: document.querySelector('[data-sim-output="install-monthly-savings"]'),
                rentalMonthlySavings: document.querySelector('[data-sim-output="rental-monthly-savings"]'),
                installInvestment: document.querySelector('[data-sim-output="install-investment"]'),
                installSavingsTotal: document.querySelector('[data-sim-output="install-savings-total"]'),
                rentalSavingsTotal: document.querySelector('[data-sim-output="rental-savings-total"]'),
                annualGeneration: document.querySelector('[data-sim-output="annual-generation"]'),
                coverageLabel: document.querySelector('[data-sim-output="coverage-label"]'),
                installTime: document.querySelector('[data-sim-output="install-time"]'),
                installPayback: document.querySelector('[data-sim-output="install-payback"]'),
                installBadge: document.querySelector('[data-sim-output="install-badge"]'),
                rentalBadge: document.querySelector('[data-sim-output="rental-badge"]'),
                rentalMonthly: document.querySelector('[data-sim-output="rental-monthly"]'),
                rentalDiscountLabel: document.querySelector('[data-sim-output="rental-discount-label"]'),
                annualSavingsAverage: document.querySelector('[data-sim-output="annual-savings-average"]'),
                paybackResume: document.querySelector('[data-sim-output="payback-resume"]'),
                fiveYearSavings: document.querySelector('[data-sim-output="five-year-savings"]'),
                horizonLabel: document.querySelector('[data-sim-output="horizon-label"]')
            };

            const coverageProgress = document.querySelector('[data-sim-progress="coverage"]');
            const actionButtons = document.querySelectorAll('[data-sim-action="recalculate"]');

            const tooltipTriggerList = Array.from(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.forEach((tooltipTriggerEl) => {
                if (window.bootstrap && bootstrap.Tooltip) {
                    new bootstrap.Tooltip(tooltipTriggerEl);
                }
            });

            let projectionChart;
            const defaultTimelineLength = 12;

            function generateTimelineLabels(length) {
                const total = Math.max(1, length);
                return Array.from({ length: total }, (_, index) => `Ano ${index + 1}`);
            }

            function initializeProjectionChart() {
                const canvas = document.getElementById('projectionChart');
                if (!canvas) return;

                const context = canvas.getContext('2d');
                if (!context) return;

                const defaultLabels = generateTimelineLabels(defaultTimelineLength);
                const defaultData = new Array(defaultLabels.length).fill(0);

                projectionChart = new Chart(context, {
                    type: 'line',
                    data: {
                        labels: defaultLabels,
                        datasets: [
                            {
                                label: 'Economia acumulada - Instalação',
                                data: defaultData.slice(),
                                borderColor: '#f97316',
                                backgroundColor: 'rgba(249, 115, 22, 0.12)',
                                tension: 0.35,
                                fill: true,
                                pointRadius: 0,
                                borderWidth: 3
                            },
                            {
                                label: 'Economia acumulada - Aluguel',
                                data: defaultData.slice(),
                                borderColor: '#2563eb',
                                backgroundColor: 'rgba(37, 99, 235, 0.12)',
                                tension: 0.35,
                                fill: true,
                                pointRadius: 0,
                                borderWidth: 3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    usePointStyle: true
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const label = context.dataset.label || '';
                                        return `${label}: ${formatCurrency(context.parsed.y)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    color: 'rgba(26, 43, 61, 0.08)'
                                }
                            },
                            y: {
                                ticks: {
                                    callback: (value) => formatCurrency(value)
                                },
                                grid: {
                                    color: 'rgba(26, 43, 61, 0.05)'
                                }
                            }
                        }
                    }
                });
            }

            function parseInput(inputName) {
                const element = document.querySelector(`[data-sim-input="${inputName}"]`);
                if (!element) return 0;

                const value = parseFloat((element.value || '').toString().replace(',', '.'));
                return Number.isFinite(value) ? value : 0;
            }

            function tryGetParamFromObject(name) {
                const keys = companyParamKeys[name] ?? [];
                if (!keys.length || !window.companyParameters || typeof window.companyParameters !== 'object') {
                    return null;
                }

                for (const key of keys) {
                    const value = window.companyParameters[key];
                    const numericValue = parseFloat((value ?? '').toString());
                    if (Number.isFinite(numericValue)) {
                        return numericValue;
                    }
                }

                return null;
            }

            function parseCompanyParam(name, fallback) {
                const objectValue = tryGetParamFromObject(name);
                if (objectValue !== null) {
                    return objectValue;
                }

                const element = document.querySelector(`[data-company-param="${name}"]`);
                if (!element) return fallback;

                const value = parseFloat((element.value || '').toString().replace(',', '.'));
                return Number.isFinite(value) ? value : fallback;
            }

            function formatCurrency(value) {
                return Number.isFinite(value) ? currencyFormatter.format(value) : '-';
            }

            function formatNumber(value, suffix = '') {
                return Number.isFinite(value) ? `${numberFormatter.format(value)}${suffix}` : '-';
            }

            function formatPercent(value) {
                return Number.isFinite(value) ? percentFormatter.format(value) : '-';
            }

            function formatPercentNumber(value) {
                if (!Number.isFinite(value)) {
                    return '-';
                }

                return `${value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}%`;
            }

            function formatMonths(totalMonths) {
                if (!Number.isFinite(totalMonths)) {
                    return '-';
                }

                if (totalMonths < 12) {
                    return `${Math.round(totalMonths)} meses`;
                }

                const years = Math.floor(totalMonths / 12);
                const months = Math.round(totalMonths % 12);

                if (months === 0) {
                    return `${years} ${years === 1 ? 'ano' : 'anos'}`;
                }

                return `${years} ${years === 1 ? 'ano' : 'anos'} e ${months} ${months === 1 ? 'mês' : 'meses'}`;
            }

            function updateBadge(element, savings) {
                if (!element) return;

                element.classList.remove('badge-positive', 'badge-negative');

                if (!Number.isFinite(savings) || Math.abs(savings) < 1) {
                    element.textContent = 'Sem economia';
                    return;
                }

                if (savings > 0) {
                    element.textContent = 'Economia projetada';
                    element.classList.add('badge-positive');
                } else {
                    element.textContent = 'Revise os custos';
                    element.classList.add('badge-negative');
                }
            }

            const calculateUserSimulationUrl = '@Url.Action("CalculateUserSimulation", "Simulation")';
            const antiForgeryTokenInput = document.querySelector('#user-simulation-form input[name="__RequestVerificationToken"]')
                || document.querySelector('input[name="__RequestVerificationToken"]');
            const hiddenCompanyIdInput = document.querySelector('input[name="SelectedCompanyId"]');
            const hiddenCompanyNameInput = document.querySelector('input[name="SelectedCompanyName"]');

            function buildSimulationPayload() {
                const companyParametersPayload = window.companyParameters ?? collectCompanyParametersFromInputs();
                syncCompanyParametersJsonField(companyParametersPayload);

                return {
                    selectedCompanyId: hiddenCompanyIdInput?.value || null,
                    selectedCompanyName: hiddenCompanyNameInput?.value || null,
                    companyParameters: companyParametersPayload,
                    companyParametersJson: companyParametersJsonInput?.value || 'null',
                    userInput: {
                        monthlyConsumption: parseInput('monthly-consumption'),
                        energyTariff: parseInput('energy-tariff'),
                        coverage: parseInput('coverage'),
                        degradation: parseInput('degradation'),
                        horizonYears: Math.max(1, parseInput('horizon')),
                        inflation: parseInput('inflation')
                    }
                };
            }

            function updateProjectionChartFromResult(result) {
                if (!projectionChart) {
                    return;
                }

                const labels = Array.isArray(result.timelineLabels) && result.timelineLabels.length
                    ? result.timelineLabels
                    : generateTimelineLabels(defaultTimelineLength);

                const installSeries = Array.isArray(result.installationSavingsTimeline) && result.installationSavingsTimeline.length
                    ? result.installationSavingsTimeline
                    : new Array(labels.length).fill(0);

                const rentalSeries = Array.isArray(result.rentalSavingsTimeline) && result.rentalSavingsTimeline.length
                    ? result.rentalSavingsTimeline
                    : new Array(labels.length).fill(0);

                projectionChart.data.labels = labels;
                projectionChart.data.datasets[0].data = installSeries;
                projectionChart.data.datasets[1].data = rentalSeries;
                projectionChart.update();
            }

            function applySimulationResult(result) {
                if (!result) {
                    return;
                }

                const coveragePercent = Number(result.coveragePercent ?? result.input?.coveragePercent ?? 0);
                const horizonYears = Number(result.analyzedHorizonYears ?? result.input?.horizonYears ?? 0);

                if (outputs.baseTotal) outputs.baseTotal.textContent = formatCurrency(result.costWithoutSolar);
                if (outputs.installTotal) outputs.installTotal.textContent = formatCurrency(result.totalInstallCost);
                if (outputs.rentalTotal) outputs.rentalTotal.textContent = formatCurrency(result.totalRentalCost);
                if (outputs.installSavings) outputs.installSavings.textContent = formatCurrency(result.installationSavings);
                if (outputs.rentalSavings) outputs.rentalSavings.textContent = formatCurrency(result.rentSavings);
                if (outputs.installMonthlySavings) outputs.installMonthlySavings.textContent = formatCurrency(result.monthlySavingInstallation);
                if (outputs.rentalMonthlySavings) outputs.rentalMonthlySavings.textContent = formatCurrency(result.monthlySavingRent);
                if (outputs.installInvestment) outputs.installInvestment.textContent = formatCurrency(result.installationInvestment);
                if (outputs.installSavingsTotal) outputs.installSavingsTotal.textContent = formatCurrency(result.installationSavings);
                if (outputs.rentalSavingsTotal) outputs.rentalSavingsTotal.textContent = formatCurrency(result.rentSavings);

                if (outputs.annualGeneration) {
                    outputs.annualGeneration.textContent = Number.isFinite(result.annualGeneratedEnergyKwh)
                        ? formatNumber(result.annualGeneratedEnergyKwh, ' kWh')
                        : '-';
                }

                if (outputs.coverageLabel) {
                    outputs.coverageLabel.textContent = formatPercentNumber(coveragePercent);
                }

                if (outputs.installTime) outputs.installTime.textContent = formatMonths(result.installationTimeMonths);
                if (outputs.installPayback) {
                    outputs.installPayback.textContent =
                        Number.isFinite(result.paybackYears) ? formatMonths(result.paybackYears * 12) : 'Não alcançado';
                }

                if (outputs.rentalMonthly) outputs.rentalMonthly.textContent = formatCurrency(result.initialRentAmount);
                if (outputs.rentalDiscountLabel) outputs.rentalDiscountLabel.textContent = formatPercentNumber(result.discountAppliedPercent);
                if (outputs.annualSavingsAverage) outputs.annualSavingsAverage.textContent = formatCurrency(result.averageAnnualSaving);

                if (outputs.paybackResume) {
                    outputs.paybackResume.textContent =
                        Number.isFinite(result.paybackYears) ? formatMonths(result.paybackYears * 12) : 'Não recupera investimento';
                }

                if (outputs.fiveYearSavings) outputs.fiveYearSavings.textContent = formatCurrency(result.fiveYearAccumulatedSaving);
                if (outputs.horizonLabel) {
                    outputs.horizonLabel.textContent =
                        `${horizonYears} ${horizonYears === 1 ? 'ano' : 'anos'}`;
                }

                updateBadge(outputs.installBadge, result.installationSavings);
                updateBadge(outputs.rentalBadge, result.rentSavings);

                if (coverageProgress) {
                    const progressValue = Math.min(Math.max(coveragePercent, 0), 120);
                    coverageProgress.style.width = `${progressValue}%`;
                    coverageProgress.setAttribute('aria-valuenow', progressValue.toFixed(0));
                }

                updateProjectionChartFromResult(result);
            }

            async function recalculate() {
                const payload = buildSimulationPayload();
                const token = antiForgeryTokenInput?.value;

                try {
                    const response = await fetch(calculateUserSimulationUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            ...(token ? { 'RequestVerificationToken': token } : {})
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        console.error('Falha ao calcular simulação do usuário:', response.statusText);
                        return;
                    }

                    const result = await response.json();
                    applySimulationResult(result);
                } catch (error) {
                    console.error('Erro ao recalcular simulação do usuário:', error);
                }
            }

            function resetSimulatorOutputs() {
                if (outputs.baseTotal) outputs.baseTotal.textContent = formatCurrency(0);
                if (outputs.installTotal) outputs.installTotal.textContent = formatCurrency(0);
                if (outputs.rentalTotal) outputs.rentalTotal.textContent = formatCurrency(0);

                if (outputs.installSavings) outputs.installSavings.textContent = formatCurrency(0);
                if (outputs.rentalSavings) outputs.rentalSavings.textContent = formatCurrency(0);
                if (outputs.installMonthlySavings) outputs.installMonthlySavings.textContent = formatCurrency(0);
                if (outputs.rentalMonthlySavings) outputs.rentalMonthlySavings.textContent = formatCurrency(0);
                if (outputs.installSavingsTotal) outputs.installSavingsTotal.textContent = formatCurrency(0);
                if (outputs.rentalSavingsTotal) outputs.rentalSavingsTotal.textContent = formatCurrency(0);

                if (outputs.installInvestment) outputs.installInvestment.textContent = formatCurrency(0);
                if (outputs.annualGeneration) outputs.annualGeneration.textContent = '0 kWh';
                if (outputs.annualSavingsAverage) outputs.annualSavingsAverage.textContent = formatCurrency(0);
                if (outputs.fiveYearSavings) outputs.fiveYearSavings.textContent = formatCurrency(0);
                if (outputs.horizonLabel) outputs.horizonLabel.textContent = '-';

                if (outputs.coverageLabel) outputs.coverageLabel.textContent = formatPercentNumber(0);
                if (outputs.installTime) outputs.installTime.textContent = '-';
                if (outputs.installPayback) outputs.installPayback.textContent = 'Não calculado';
                if (outputs.paybackResume) outputs.paybackResume.textContent = 'Não calculado';

                if (outputs.rentalMonthly) outputs.rentalMonthly.textContent = formatCurrency(0);
                if (outputs.rentalDiscountLabel) outputs.rentalDiscountLabel.textContent = formatPercentNumber(0);

                if (outputs.installBadge) {
                    outputs.installBadge.classList.remove('badge-positive', 'badge-negative');
                    outputs.installBadge.textContent = 'Aguardando cálculo';
                }
                if (outputs.rentalBadge) {
                    outputs.rentalBadge.classList.remove('badge-positive', 'badge-negative');
                    outputs.rentalBadge.textContent = 'Aguardando cálculo';
                }

                if (coverageProgress) {
                    coverageProgress.style.width = '0%';
                    coverageProgress.setAttribute('aria-valuenow', '0');
                }

                if (projectionChart) {
                    const labels = generateTimelineLabels(defaultTimelineLength);
                    const zeroData = new Array(labels.length).fill(0);
                    projectionChart.data.labels = labels;
                    projectionChart.data.datasets[0].data = zeroData.slice();
                    projectionChart.data.datasets[1].data = zeroData.slice();
                    projectionChart.update();
                }
            }

            initializeProjectionChart();
            resetSimulatorOutputs();

            actionButtons.forEach((button) => {
                button.addEventListener('click', recalculate);
            });
        })();
    </script>
}
