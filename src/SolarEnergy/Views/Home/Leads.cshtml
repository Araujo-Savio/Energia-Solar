@model SolarEnergy.ViewModels.CompanyLeadsViewModel
@{
    ViewData["Title"] = "Central de Leads";
}

<!-- Leads Dashboard CSS -->
<link rel="stylesheet" href="~/css/leads-dashboard.css" />

<div class="container-fluid py-4">
    <!-- Header com Estatísticas de Leads -->
    <div class="leads-header-section mb-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 class="h3 text-dark mb-2">
                            <i class="fas fa-users me-3 text-solar-orange"></i>
                            Central de Leads
                        </h1>
                        <p class="text-muted mb-0">Gerencie suas solicitações de orçamento e leads</p>
                    </div>
                    <div class="d-flex gap-2">
                        <a asp-controller="Leads" asp-action="Management" class="btn btn-outline-primary">
                            <i class="fas fa-chart-line me-2"></i>Relatórios
                        </a>
                        <a asp-controller="Leads" asp-action="Purchase" class="btn btn-solar-orange">
                            <i class="fas fa-plus me-2"></i>Comprar Leads
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cards de Estatísticas -->
        <div class="row g-3 mb-4">
            <!-- Lead Balance Card -->
            <div class="col-xl-3 col-md-6">
                <div class="leads-balance-card">
                    <div class="leads-card-header">
                        <div class="leads-card-icon">
                            <i class="fas fa-coins"></i>
                        </div>
                        <div class="leads-card-title">
                            <h6>Saldo de Leads</h6>
                            <p>Créditos disponíveis</p>
                        </div>
                    </div>
                    <div class="leads-stats-grid">
                        <div class="leads-stat-item">
                            <span class="leads-stat-number available">@Model.LeadBalance.AvailableLeads</span>
                            <span class="leads-stat-label">Disponíveis</span>
                        </div>
                        <div class="leads-stat-item">
                            <span class="leads-stat-number consumed">@Model.LeadBalance.ConsumedLeads</span>
                            <span class="leads-stat-label">Consumidos</span>
                        </div>
                    </div>
                    <div class="leads-card-footer">
                        <small class="text-muted">
                            Total: @Model.LeadBalance.TotalPurchasedLeads | 
                            Investido: @Model.LeadBalance.TotalSpent.ToString("C", new System.Globalization.CultureInfo("pt-BR"))
                        </small>
                    </div>
                    @if (Model.LeadBalance.AvailableLeads == 0)
                    {
                        <div class="leads-warning-badge">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            Sem créditos
                        </div>
                    }
                </div>
            </div>

            <!-- Estatísticas Gerais -->
            <div class="col-xl-2 col-md-6">
                <div class="leads-stat-card total">
                    <div class="stat-icon">
                        <i class="fas fa-inbox"></i>
                    </div>
                    <div class="stat-content">
                        <h3>@Model.Stats.Total</h3>
                        <p>Total de Leads</p>
                    </div>
                </div>
            </div>

            <div class="col-xl-2 col-md-6">
                <div class="leads-stat-card novos">
                    <div class="stat-icon">
                        <i class="fas fa-plus-circle"></i>
                    </div>
                    <div class="stat-content">
                        <h3>@Model.Stats.Novos</h3>
                        <p>Novos</p>
                    </div>
                </div>
            </div>

            <div class="col-xl-2 col-md-6">
                <div class="leads-stat-card analise">
                    <div class="stat-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="stat-content">
                        <h3>@Model.Stats.EmAnalise</h3>
                        <p>Em Análise</p>
                    </div>
                </div>
            </div>

            <div class="col-xl-3 col-md-6">
                <div class="leads-stat-card propostas">
                    <div class="stat-icon">
                        <i class="fas fa-handshake"></i>
                    </div>
                    <div class="stat-content">
                        <h3>@Model.Stats.PropostasEnviadas</h3>
                        <p>Propostas Enviadas</p>
                        <div class="conversion-rate">
                            <span class="badge bg-success">@Model.Stats.ConversaoPercentual% taxa de conversão</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Leads -->
    <div class="leads-content-section">
        <div class="row">
            <div class="col-12">
                <div class="leads-table-card">
                    <div class="leads-table-header">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>
                            Suas Solicitações de Orçamento
                        </h5>
                        <div class="leads-table-actions">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="filterAll">Todos</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="filterNew">Novos</button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="filterAnalysis">Em Análise</button>
                            </div>
                        </div>
                    </div>

                    <div class="leads-table-body">
                        @if (Model.Quotes.Any())
                        {
                            <div class="leads-grid">
                                @foreach (var quote in Model.Quotes)
                                {
                                    <div class="lead-card @(quote.HasAccess ? "unlocked" : "locked")" data-status="@quote.Status.ToLower().Replace(" ", "-")"">
                                        <div class="lead-card-header">
                                            <div class="lead-info">
                                                <h6 class="lead-client-name">
                                                    @quote.ClientName
                                                    @if (!quote.HasAccess)
                                                    {
                                                        <i class="fas fa-lock text-warning ms-2" title="Lead bloqueado"></i>
                                                    }
                                                    else
                                                    {
                                                        <i class="fas fa-unlock text-success ms-2" title="Lead desbloqueado"></i>
                                                    }
                                                </h6>
                                                <p class="lead-service-type">@quote.ServiceType</p>
                                            </div>
                                            <div class="lead-status">
                                                @if (quote.Status == "Pendente")
                                                {
                                                    <span class="lead-badge pending">
                                                        <i class="fas fa-clock"></i> Pendente
                                                    </span>
                                                }
                                                else if (quote.Status == "Em Análise")
                                                {
                                                    <span class="lead-badge analysis">
                                                        <i class="fas fa-search"></i> Em Análise
                                                    </span>
                                                }
                                                else if (quote.HasProposal)
                                                {
                                                    <span class="lead-badge completed">
                                                        <i class="fas fa-check"></i> Proposta Enviada
                                                    </span>
                                                }
                                            </div>
                                        </div>

                                        <div class="lead-card-body">
                                            <div class="lead-details">
                                                <div class="detail-item">
                                                    <i class="fas fa-map-marker-alt text-muted"></i>
                                                    <span>@quote.ClientLocation</span>
                                                </div>
                                                <div class="detail-item">
                                                    <i class="fas fa-bolt text-warning"></i>
                                                    <span>@quote.MonthlyConsumptionKwh kWh/mês</span>
                                                </div>
                                                <div class="detail-item">
                                                    <i class="fas fa-calendar text-info"></i>
                                                    <span>@quote.RequestDate.ToString("dd/MM/yyyy")</span>
                                                </div>
                                                @if (quote.UnreadMessagesCount > 0)
                                                {
                                                    <div class="detail-item">
                                                        <i class="fas fa-envelope text-danger"></i>
                                                        <span class="text-danger">@quote.UnreadMessagesCount mensagem(s) não lida(s)</span>
                                                    </div>
                                                }
                                            </div>

                                            @if (quote.HasAccess)
                                            {
                                                <div class="lead-message">
                                                    <p class="mb-0">@(string.IsNullOrEmpty(quote.Message) ? "Sem mensagem adicional" : quote.Message)</p>
                                                </div>
                                                
                                                <div class="lead-contact-info">
                                                    <div class="contact-item">
                                                        <i class="fas fa-envelope"></i>
                                                        <a href="mailto:@quote.ClientEmail">@quote.ClientEmail</a>
                                                    </div>
                                                    @if (!string.IsNullOrEmpty(quote.ClientPhone))
                                                    {
                                                        <div class="contact-item">
                                                            <i class="fas fa-phone"></i>
                                                            <a href="tel:@quote.ClientPhone">@quote.ClientPhone</a>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="lead-locked-message">
                                                    <i class="fas fa-lock fa-2x text-warning mb-2"></i>
                                                    <p class="text-muted">Desbloqueie este lead para ver os dados completos do cliente e poder entrar em contato.</p>
                                                </div>
                                            }
                                        </div>

                                        <div class="lead-card-footer">
                                            @if (!quote.HasAccess && quote.CanPurchaseAccess)
                                            {
                                                <button type="button" 
                                                        class="btn btn-solar-orange btn-sm unlock-lead-btn flex-grow-1"
                                                        data-quote-id="@quote.QuoteId"
                                                        data-client-name="@quote.ClientName">
                                                    <i class="fas fa-unlock me-1"></i>
                                                    Desbloquear (1 crédito)
                                                </button>
                                            }
                                            else if (!quote.HasAccess && !quote.CanPurchaseAccess)
                                            {
                                                <a asp-controller="Leads" asp-action="Purchase" class="btn btn-outline-warning btn-sm flex-grow-1">
                                                    <i class="fas fa-shopping-cart me-1"></i>
                                                    Comprar Leads
                                                </a>
                                            }
                                            else if (quote.HasAccess)
                                            {
                                                <div class="btn-group w-100" role="group">
                                                    @if (quote.UnreadMessagesCount > 0 || quote.LastMessageDate.HasValue)
                                                    {
                                                        <a asp-controller="Chat" asp-action="Index" asp-route-quoteId="@quote.QuoteId" 
                                                           class="btn btn-primary btn-sm">
                                                            <i class="fas fa-comments me-1"></i>
                                                            Chat
                                                            @if (quote.UnreadMessagesCount > 0)
                                                            {
                                                                <span class="badge bg-danger ms-1">@quote.UnreadMessagesCount</span>
                                                            }
                                                        </a>
                                                    }

                                                    @if (!quote.HasProposal)
                                                    {
                                                        <button type="button" class="btn btn-solar-orange btn-sm"
                                                                data-bs-toggle="modal" data-bs-target="#responseModal"
                                                                data-quote-id="@quote.QuoteId" 
                                                                data-client-name="@quote.ClientName"
                                                                data-service-type="@quote.ServiceType">
                                                            <i class="fas fa-reply me-1"></i>Responder
                                                        </button>
                                                    }

                                                    <a asp-action="ViewQuoteDetails" asp-route-id="@quote.QuoteId" 
                                                       class="btn btn-outline-primary btn-sm">
                                                        <i class="fas fa-eye me-1"></i>Detalhes
                                                    </a>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="leads-empty-state">
                                <div class="empty-state-content">
                                    <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                                    <h4 class="text-muted">Nenhuma solicitação de orçamento</h4>
                                    <p class="text-muted">Quando clientes solicitarem orçamentos para sua empresa, eles aparecerão aqui.</p>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Profissional para Desbloquear Lead -->
<div class="modal fade" id="unlockLeadModal" tabindex="-1" aria-labelledby="unlockLeadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content unlock-modal">
            <div class="modal-header unlock-modal-header">
                <div class="unlock-modal-icon">
                    <i class="fas fa-unlock-alt"></i>
                </div>
                <div class="unlock-modal-title">
                    <h5 class="modal-title" id="unlockLeadModalLabel">
                        Desbloquear Lead Premium
                    </h5>
                    <p class="modal-subtitle">Acesse os dados completos do cliente</p>
                </div>
                <button type="button" class="btn-close unlock-modal-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body unlock-modal-body">
                <div class="client-preview">
                    <div class="client-preview-header">
                        <div class="client-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="client-info">
                            <h6 class="client-name" id="unlockClientName">Nome do Cliente</h6>
                            <p class="client-service" id="unlockServiceType">Tipo de Serviço</p>
                        </div>
                        <div class="client-consumption">
                            <span class="consumption-value" id="unlockConsumption">0 kWh</span>
                            <span class="consumption-label">Consumo Mensal</span>
                        </div>
                    </div>
                </div>

                <div class="unlock-benefits">
                    <h6 class="benefits-title">
                        <i class="fas fa-gift me-2"></i>
                        O que você vai receber:
                    </h6>
                    <div class="benefits-grid">
                        <div class="benefit-item">
                            <i class="fas fa-envelope text-primary"></i>
                            <span>Email direto do cliente</span>
                        </div>
                        <div class="benefit-item">
                            <i class="fas fa-phone text-success"></i>
                            <span>Telefone de contato</span>
                        </div>
                        <div class="benefit-item">
                            <i class="fas fa-comments text-info"></i>
                            <span>Chat liberado</span>
                        </div>
                        <div class="benefit-item">
                            <i class="fas fa-map-marker-alt text-warning"></i>
                            <span>Localização completa</span>
                        </div>
                        <div class="benefit-item">
                            <i class="fas fa-file-alt text-secondary"></i>
                            <span>Mensagem detalhada</span>
                        </div>
                        <div class="benefit-item">
                            <i class="fas fa-star text-warning"></i>
                            <span>Acesso vitalício</span>
                        </div>
                    </div>
                </div>

                <div class="unlock-cost">
                    <div class="cost-display">
                        <div class="cost-info">
                            <span class="cost-label">Investimento:</span>
                            <span class="cost-value">1 Crédito</span>
                        </div>
                        <div class="cost-equivalent">
                            <span class="equivalent-value">≈ R$ 14,99</span>
                        </div>
                    </div>
                </div>

                <div class="current-balance">
                    <div class="balance-info">
                        <i class="fas fa-coins text-warning me-2"></i>
                        <span>Saldo atual: <strong id="currentBalance">@Model.LeadBalance.AvailableLeads</strong> créditos</span>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer unlock-modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-gradient-orange" id="confirmUnlockBtn">
                    <i class="fas fa-unlock me-2"></i>
                    <span class="btn-text">Desbloquear Agora</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para resposta da empresa -->
<div class="modal fade" id="responseModal" tabindex="-1" aria-labelledby="responseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-solar-orange text-white">
                <h5 class="modal-title" id="responseModalLabel">
                    <i class="fas fa-reply me-2"></i>
                    Responder Orçamento
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form asp-controller="Home" asp-action="SendCompanyResponse" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" id="modalQuoteId" name="QuoteId" />
                
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Cliente:</strong> <span id="modalClientName"></span><br>
                        <strong>Serviço:</strong> <span id="modalServiceType"></span>
                    </div>

                    <div class="mb-3">
                        <label for="responseMessageText" class="form-label fw-bold">
                            <i class="fas fa-comment me-1"></i>
                            Sua Mensagem
                        </label>
                        <textarea class="form-control" id="responseMessageText" name="Message" rows="4" 
                                  placeholder="Digite sua resposta ao cliente..."></textarea>
                        <div class="form-text">
                            Explique como sua empresa pode ajudar este cliente.
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-solar-orange">
                        <i class="fas fa-paper-plane me-1"></i>
                        Enviar Resposta
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const unlockModal = new bootstrap.Modal(document.getElementById('unlockLeadModal'));
    const responseModal = document.getElementById('responseModal');
    
    let currentQuoteId = null;
    let currentBalance = @Model.LeadBalance.AvailableLeads;

    function updateBalanceDisplay(newBalance) {
        currentBalance = newBalance;
        document.getElementById('currentBalance').textContent = newBalance;
        const balanceElements = document.querySelectorAll('.leads-stat-number.available');
        balanceElements.forEach(el => el.textContent = newBalance);
    }

    const unlockButtons = document.querySelectorAll('.unlock-lead-btn');
    unlockButtons.forEach(button => {
        button.addEventListener('click', function() {
            const quoteId = this.dataset.quoteId;
            const clientName = this.dataset.clientName;
            const serviceType = this.closest('.lead-card').querySelector('.lead-service-type').textContent;
            const consumption = this.closest('.lead-card').querySelector('.detail-item .fas.fa-bolt').nextElementSibling.textContent;
            
            currentQuoteId = quoteId;
            
            document.getElementById('unlockClientName').textContent = clientName;
            document.getElementById('unlockServiceType').textContent = serviceType;
            document.getElementById('unlockConsumption').textContent = consumption;
            
            const confirmBtn = document.getElementById('confirmUnlockBtn');
            if (currentBalance <= 0) {
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '<i class="fas fa-shopping-cart me-2"></i><span class="btn-text">Comprar Leads</span>';
                confirmBtn.onclick = () => {
                    unlockModal.hide();
                    setTimeout(() => window.location.href = '/Leads/Purchase', 300);
                };
            } else {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '<i class="fas fa-unlock me-2"></i><span class="btn-text">Desbloquear Agora</span>';
                confirmBtn.onclick = confirmUnlock;
            }
            
            unlockModal.show();
        });
    });

    function confirmUnlock() {
        if (!currentQuoteId) return;
        
        const confirmBtn = document.getElementById('confirmUnlockBtn');
        confirmBtn.classList.add('btn-loading');
        confirmBtn.disabled = true;
        
        const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';
        
        fetch('/Leads/ConsumeLead', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `quoteId=${currentQuoteId}&__RequestVerificationToken=${encodeURIComponent(token)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateBalanceDisplay(currentBalance - 1);
                unlockModal.hide();
                alert('Lead desbloqueado com sucesso! A página será recarregada.');
                window.location.reload();
            } else {
                throw new Error(data.message || 'Erro desconhecido');
            }
        })
        .catch(error => {
            console.error('Unlock error:', error);
            alert('Erro: ' + error.message);
        })
        .finally(() => {
            confirmBtn.classList.remove('btn-loading');
            confirmBtn.disabled = false;
            currentQuoteId = null;
        });
    }

    if (responseModal) {
        responseModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const quoteId = button.getAttribute('data-quote-id');
            const clientName = button.getAttribute('data-client-name');
            const serviceType = button.getAttribute('data-service-type');
            
            document.getElementById('modalQuoteId').value = quoteId;
            document.getElementById('modalClientName').textContent = clientName;
            document.getElementById('modalServiceType').textContent = serviceType;
        });
    }

    const filterButtons = document.querySelectorAll('[id^="filter"]');
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            filterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            const filter = this.id.replace('filter', '').toLowerCase();
            const leadCards = document.querySelectorAll('.lead-card');
            
            leadCards.forEach(card => {
                if (filter === 'all') {
                    card.style.display = 'block';
                } else {
                    const status = card.dataset.status;
                    if (status === filter || 
                        (filter === 'new' && status === 'pendente') ||
                        (filter === 'analysis' && status === 'em-análise')) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                }
            });
        });
    });
});
</script>
