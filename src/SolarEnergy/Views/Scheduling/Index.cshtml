@model SolarEnergy.ViewModels.ScheduleVisitViewModel
@using System.Collections.Generic
@using SolarEnergy.Models
@using System.Text.Json
@using System.Text.Json.Serialization

@functions {
    private static IEnumerable<(string Value, string Text)> GetServiceOptions(SolarServiceType? serviceType)
    {
        return serviceType switch
        {
            SolarServiceType.PanelSales => new List<(string Value, string Text)>
            {
                ("Venda de Painéis Solares", "Venda de Painéis Solares")
            },
            SolarServiceType.EnergyRental => new List<(string Value, string Text)>
            {
                ("Aluguel de Energia Solar", "Aluguel de Energia Solar")
            },
            SolarServiceType.Both => new List<(string Value, string Text)>
            {
                ("Venda de Painéis Solares", "Venda de Painéis Solares"),
                ("Aluguel de Energia Solar", "Aluguel de Energia Solar"),
                ("Consultoria", "Consultoria (Venda ou Aluguel)")
            },
            _ => new List<(string Value, string Text)>
            {
                ("Venda de Painéis Solares", "Venda de Painéis Solares"),
                ("Aluguel de Energia Solar", "Aluguel de Energia Solar")
            }
        };
    }
}

@{
    ViewData["Title"] = "Agendar Visita Técnica";

    var companyServiceTypes = Model.CompanyServiceTypes ?? new Dictionary<string, SolarServiceType?>();
    var selectedCompanyId = Model.CompanyId;
    SolarServiceType? selectedCompanyServiceType = null;

    if (!string.IsNullOrEmpty(selectedCompanyId) && companyServiceTypes.TryGetValue(selectedCompanyId, out var resolvedServiceType))
    {
        selectedCompanyServiceType = resolvedServiceType;
    }

    var initialServiceOptions = GetServiceOptions(selectedCompanyServiceType);

    var jsonOptions = new JsonSerializerOptions
    {
        Converters = { new JsonStringEnumConverter() }
    };

    var companyServiceTypesJson = JsonSerializer.Serialize(companyServiceTypes, jsonOptions);
    var isCompanySelected = !string.IsNullOrEmpty(selectedCompanyId);
}

<div class="container py-5">
    <div class="mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb small text-muted mb-0">
                <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index" class="text-decoration-none">Início</a></li>
                <li class="breadcrumb-item active" aria-current="page">Agendamentos</li>
            </ol>
        </nav>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-lg border-0 schedule-card">
                <div class="card-header schedule-card-header d-flex align-items-center">
                    <div class="icon-wrapper me-3">
                        <i class="fas fa-calendar-check"></i>
                    </div>
                    <div>
                        <h3 class="mb-1">Agendar Visita Técnica</h3>
                        <p class="mb-0 text-muted">Defina a empresa e o horário para a próxima visita técnica.</p>
                    </div>
                </div>
                <div class="card-body p-4">
                    <form asp-action="Create" method="post" class="row g-4" data-testid="form-agendamento" data-loading-form>
                        @Html.AntiForgeryToken()
                        <div id="companyServiceTypesData" data-company-service-types='@Html.Raw(companyServiceTypesJson)' class="d-none" aria-hidden="true"></div>
                        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert" aria-live="polite"></div>

                        <div class="col-md-6">
                            <label asp-for="CompanyId" class="form-label">
                                @Html.DisplayNameFor(m => m.CompanyId)
                                <span class="text-danger" aria-hidden="true">*</span>
                            </label>
                            <select asp-for="CompanyId" class="form-select" asp-items="Model.Companies" data-testid="select-company">
                                <option value="">Selecione uma empresa</option>
                            </select>
                            <span asp-validation-for="CompanyId" class="text-danger"></span>
                        </div>

                        <div class="col-md-6">
                            <label asp-for="ServiceType" class="form-label">
                                @Html.DisplayNameFor(m => m.ServiceType)
                                <span class="text-danger" aria-hidden="true">*</span>
                            </label>
                            <select asp-for="ServiceType"
                                    class="form-select"
                                    data-testid="input-servicetype"
                                    data-placeholder="Selecione o tipo de serviço"
                                    data-selected-value="@Model.ServiceType"
                                    @(isCompanySelected ? string.Empty : "disabled")
                                    required>
                                <option value="">Selecione o tipo de serviço</option>
                                @foreach (var option in initialServiceOptions)
                                {
                                    <option value="@option.Value" @(Model.ServiceType == option.Value ? "selected" : string.Empty)>@option.Text</option>
                                }
                            </select>
                            <span asp-validation-for="ServiceType" class="text-danger"></span>
                        </div>

                        <div class="col-md-3">
                            <label asp-for="VisitDate" class="form-label">
                                @Html.DisplayNameFor(m => m.VisitDate)
                                <span class="text-danger" aria-hidden="true">*</span>
                            </label>
                            <input asp-for="VisitDate" class="form-control" type="date" data-testid="input-visitdate" />
                            <span asp-validation-for="VisitDate" class="text-danger"></span>
                        </div>

                        <div class="col-md-3">
                            <label asp-for="VisitTime" class="form-label">
                                @Html.DisplayNameFor(m => m.VisitTime)
                                <span class="text-danger" aria-hidden="true">*</span>
                            </label>
                            <select asp-for="VisitTime" class="form-select" asp-items="Model.VisitTimeOptions" data-testid="input-visittime"></select>
                            <span asp-validation-for="VisitTime" class="text-danger"></span>
                        </div>

                        <div class="col-12">
                            <label asp-for="Address" class="form-label">@Html.DisplayNameFor(m => m.Address)</label>
                            <input asp-for="Address" class="form-control" placeholder="Rua, número, bairro, cidade" data-testid="input-address" />
                            <span asp-validation-for="Address" class="text-danger"></span>
                        </div>

                        <div class="col-12">
                            <label asp-for="Notes" class="form-label">@Html.DisplayNameFor(m => m.Notes)</label>
                            <textarea asp-for="Notes" class="form-control" rows="4" placeholder="Observações adicionais (opcional)" data-testid="input-notes"></textarea>
                            <span asp-validation-for="Notes" class="text-danger"></span>
                        </div>

                        <div class="col-12 d-flex flex-column flex-md-row justify-content-between align-items-md-center pt-3 gap-3">
                            <a asp-action="List" class="btn btn-outline-secondary">
                                <i class="fas fa-list me-2"></i>Ver Agendamentos
                            </a>
                            <button type="submit" class="btn btn-solar-orange px-4" data-testid="btn-salvar" data-loading-text="Agendando...">
                                <i class="fas fa-paper-plane me-2"></i>Agendar Visita
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script src="~/js/scheduling.js" asp-append-version="true"></script>
}
