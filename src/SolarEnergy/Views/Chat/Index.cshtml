@model SolarEnergy.ViewModels.QuoteChatViewModel
@{
    ViewData["Title"] = $"Chat - Orçamento #{Model.QuoteId.ToString("D6")}";
}

<!-- Chat CSS -->
<link rel="stylesheet" href="~/css/chat.css" />

<div class="chat-container">
    <!-- Sidebar com informações do orçamento -->
    <aside class="chat-sidebar">
    <!-- Informações do Orçamento -->
        <div class="sidebar-section">
            <h6>
                <i class="fas fa-file-invoice"></i>
                Informações do Orçamento
            </h6>
            
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Número</span>
                    <span class="info-value">#@Model.QuoteId.ToString("D6")</span>
                </div>
                
                <div class="info-item">
                    <span class="info-label">Status</span>
                    @if (Model.Status == "Pendente")
                    {
                        <span class="info-badge status-pending">
                            <i class="fas fa-clock"></i>
                            Pendente
                        </span>
                    }
                    else if (Model.Status == "Em Análise")
                    {
                        <span class="info-badge status-analysis">
                            <i class="fas fa-search"></i>
                            Em Análise
                        </span>
                    }
                    else if (Model.HasProposal)
                    {
                        <span class="info-badge status-completed">
                            <i class="fas fa-check-circle"></i>
                            Proposta Enviada
                        </span>
                    }
                    else
                    {
                        <span class="info-badge">@Model.Status</span>
                    }
                </div>
                
                <div class="info-item">
                    <span class="info-label">@(Model.CurrentUserType == "Client" ? "Empresa" : "Cliente")</span>
                    <span class="info-value">@(Model.CurrentUserType == "Client" ? Model.CompanyName : Model.ClientName)</span>
                </div>
                
                <div class="info-item">
                    <span class="info-label">Consumo Mensal</span>
                    <span class="info-value">@Model.MonthlyConsumptionKwh.ToString("N0") kWh</span>
                </div>
                
                <div class="info-item">
                    <span class="info-label">Serviço</span>
                    <span class="info-value">@Model.ServiceType</span>
                </div>
                
                <div class="info-item">
                    <span class="info-label">Solicitado em</span>
                    <span class="info-value">@Model.RequestDate.ToString("dd/MM/yyyy")</span>
                </div>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(Model.InitialMessage))
        {
            <div class="sidebar-section">
                <h6>
                    <i class="fas fa-comment-dots"></i>
                    Mensagem Inicial
                </h6>
                <div class="info-value">
                    @Model.InitialMessage
                </div>
            </div>
        }

        @if (!string.IsNullOrEmpty(Model.CompanyResponseMessage))
        {
            <div class="sidebar-section">
                <h6>
                    <i class="fas fa-reply"></i>
                    Resposta da Empresa
                </h6>
                <div class="info-value">
                    @Model.CompanyResponseMessage
                </div>
                @if (Model.CompanyResponseDate.HasValue)
                {
                    <div class="info-item" style="margin-top: 0.5rem;">
                        <span class="info-label">Respondido em</span>
                        <span class="info-value">@Model.CompanyResponseDate.Value.ToString("dd/MM/yyyy HH:mm")</span>
                    </div>
                }
            </div>
        }

        @if (Model.HasProposal)
        {
            <div class="sidebar-section">
                <h6>
                    <i class="fas fa-file-contract"></i>
                    Propostas (@Model.Proposals.Count)
                </h6>
                @foreach (var proposal in Model.Proposals.Take(2))
                {
                    <div class="proposal-summary">
                        <span class="info-label">Valor</span>
                        <span class="info-value proposal-value">
                            @proposal.Value.ToString("C", new System.Globalization.CultureInfo("pt-BR"))
                        </span>
                        <div class="proposal-date">
                            @proposal.ProposalDate.ToString("dd/MM/yyyy")
                        </div>
                    </div>
                }
                @if (Model.CurrentUserType == "Client")
                {
                    <a asp-controller="Quote" asp-action="Details" asp-route-id="@Model.QuoteId" 
                       class="btn btn-details">
                        <i class="fas fa-eye me-1"></i>Ver Detalhes
                    </a>
                }
            </div>
        }
    </aside>

    <!-- Área Principal do Chat -->
    <main class="chat-main">
        <!-- Header do Chat -->
        <header class="chat-header">
            <div class="chat-header-content">
                <h1 class="chat-title">
                    <i class="fas fa-comments"></i>
                    Chat do Orçamento
                </h1>
                <p class="chat-subtitle">
                    Conversa com @(Model.CurrentUserType == "Client" ? Model.CompanyName : Model.ClientName)
                </p>
                <div class="chat-status">
                    <span class="status-indicator"></span>
                    Online
                </div>
            </div>
        </header>

    <!-- Área de Mensagens -->
        <div class="messages-container chat-scroll-smooth" id="messagesContainer">
            @if (Model.Messages.Any())
            {
                var groupedMessages = Model.Messages
                    .GroupBy(m => m.SentDate.Date)
                    .OrderBy(g => g.Key);

                @foreach (var dayGroup in groupedMessages)
                {
                    <div class="message-date-separator">
                        <span class="message-date-text">
                            @if (dayGroup.Key.Date == DateTime.Today)
                            {
                                <text>Hoje</text>
                            }
                            else if (dayGroup.Key.Date == DateTime.Today.AddDays(-1))
                            {
                                <text>Ontem</text>
                            }
                            else
                            {
                                @dayGroup.Key.ToString("dd 'de' MMMM", new System.Globalization.CultureInfo("pt-BR"))
                            }
                        </span>
                    </div>

                    <div class="message-group">
                        @foreach (var message in dayGroup.OrderBy(m => m.SentDate))
                        {
                            <div class="message-item @(message.IsCurrentUser ? "outgoing" : "incoming") chat-fade-in">
                                <div class="message-avatar">
                                    @if (message.SenderType == "Client")
                                    {
                                        @Model.ClientName.Substring(0, 1).ToUpper()
                                    }
                                    else
                                    {
                                        @Model.CompanyName.Substring(0, 1).ToUpper()
                                    }
                                </div>
                                
                                <div class="message-bubble">
                                    <div class="message-header">
                                        <span class="message-sender">@message.SenderName</span>
                                        <span class="message-time">@message.SentDate.ToString("HH:mm")</span>
                                    </div>
                                    <div class="message-content">@message.Message</div>
                                    @if (message.IsCurrentUser)
                                    {
                                        <div class="message-status">
                                            @if (message.IsRead)
                                            {
                                                <i class="fas fa-check-double" title="Lida"></i>
                                                <span>Lida</span>
                                            }
                                            else
                                            {
                                                <i class="fas fa-check" title="Enviada"></i>
                                                <span>Enviada</span>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            }
            else
            {
                <div class="chat-empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-comments"></i>
                    </div>
                    <h3 class="empty-state-title">Nenhuma mensagem ainda</h3>
                    <p class="empty-state-text">
                        Inicie a conversa enviando uma mensagem. 
                        Esta é uma linha direta de comunicação entre você e @(Model.CurrentUserType == "Client" ? Model.CompanyName : Model.ClientName).
                    </p>
                </div>
            }
        </div>

    <!-- Área de Input -->
        <footer class="message-input-area">
            <form asp-controller="Chat" asp-action="SendMessage" method="post" id="chatForm">
                @Html.AntiForgeryToken()
                <input type="hidden" name="QuoteId" value="@Model.QuoteId" />
                
                <div class="message-input-container">
                    <div class="message-input-wrapper">
                        <textarea name="Message" 
                                  class="message-input" 
                                  rows="1" 
                                  placeholder="Digite sua mensagem..." 
                                  required 
                                  maxlength="2000"
                                  id="messageInput"></textarea>
                        <div class="message-input-hint">
                            <i class="fas fa-keyboard"></i>
                            <span>Ctrl + Enter para enviar</span>
                        </div>
                    </div>
                    
                    <button type="submit" class="send-button" id="sendButton">
                        <i class="fas fa-paper-plane"></i>
                        <span class="sr-only">Enviar mensagem</span>
                    </button>
                </div>
            </form>
        </footer>
    </main>
</div>

<!-- Navegação -->
<div class="container mt-3 mb-4">
    <div class="text-center">
        @if (Model.CurrentUserType == "Client")
        {
            <a asp-controller="Quote" asp-action="MyQuotes" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Voltar aos Meus Orçamentos
            </a>
        }
        else if (Model.CurrentUserType == "Company")
        {
            <a asp-controller="Home" asp-action="Leads" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Voltar aos Leads
            </a>
        }
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const messagesContainer = document.getElementById('messagesContainer');
    const messageForm = document.getElementById('chatForm');
    const messageTextarea = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');

    // Auto resize textarea
    function autoResize() {
        if (messageTextarea) {
            messageTextarea.style.height = 'auto';
            messageTextarea.style.height = Math.min(messageTextarea.scrollHeight, 120) + 'px';
        }
    }

    // Auto scroll para a última mensagem
    function scrollToBottom(smooth = true) {
        if (messagesContainer) {
            const scrollOptions = {
                top: messagesContainer.scrollHeight,
                behavior: smooth ? 'smooth' : 'auto'
            };
            messagesContainer.scrollTo(scrollOptions);
        }
    }

    // Scroll inicial
    setTimeout(() => scrollToBottom(false), 100);

    if (messageTextarea) {
        // Auto resize do textarea
        messageTextarea.addEventListener('input', autoResize);
        messageTextarea.addEventListener('keydown', function(e) {
            // Envio com Ctrl+Enter
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                if (messageForm) {
                    messageForm.submit();
                }
            }
            
            // Auto resize
            setTimeout(autoResize, 0);
        });

    // Disable/enable send button baseado no conteúdo
        messageTextarea.addEventListener('input', function() {
            const hasContent = this.value.trim().length > 0;
            if (sendButton) {
                sendButton.disabled = !hasContent;
            }
        });

    // Focus no input ao carregar a página
        messageTextarea.focus();
        
        // Initialize textarea
        autoResize();
        if (sendButton) {
            sendButton.disabled = messageTextarea.value.trim().length === 0;
        }
    }

    // Marcar mensagens como lidas quando a página carrega
    fetch('/Chat/MarkAsRead', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
        },
        body: JSON.stringify({ quoteId: @Model.QuoteId })
    }).catch(error => console.error('Erro ao marcar mensagens como lidas:', error));

    // Auto-refresh das mensagens a cada 30 segundos
    setInterval(function() {
        fetch('/Chat/GetUnreadCount?quoteId=@Model.QuoteId')
            .then(response => response.json())
            .then(data => {
                if (data.count > 0) {
                    // Reload apenas se houver novas mensagens e o usuário não estiver digitando
                    if (!messageTextarea || !messageTextarea.value.trim()) {
                        location.reload();
                    }
                }
            })
            .catch(error => console.error('Erro ao verificar novas mensagens:', error));
    }, 30000);

    // Feedback visual ao enviar
    if (messageForm) {
    messageForm.addEventListener('submit', function() {
        setTimeout(function() {
            if (sendButton) {
                sendButton.disabled = true;
                sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            }
            if (messageTextarea) {
                messageTextarea.disabled = true;
            }
        }, 100); // 100ms para garantir que o submit já foi processado
    });
    }
});