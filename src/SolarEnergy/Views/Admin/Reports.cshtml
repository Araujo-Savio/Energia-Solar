@model SolarEnergy.ViewModels.AdminReportsViewModel
@{
    ViewData["Title"] = "Relatórios Administrativos";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["BreadcrumbItems"] = new List<dynamic>
    {
        new { Title = "Relatórios", Url = "", IsActive = true }
    };
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin-reports.css" asp-append-version="true" />
}

<div class="admin-reports-page admin-fade-in">
    <div class="container-fluid px-4">
        @Html.AntiForgeryToken()
        
        <!-- Page Header -->
        <div class="admin-reports-header">
            <div class="reports-title">
                <i class="fas fa-chart-bar me-3 text-admin-info"></i>
                Relatórios Administrativos
            </div>
            <p class="reports-subtitle">
                Analise métricas detalhadas e receita real da plataforma Solar Energy
            </p>
        </div>

        <!-- Visão Geral dos Relatórios com Receita Real -->
        <div class="reports-overview">
            <div class="overview-card revenue">
                <div class="overview-icon revenue">
                    <i class="fas fa-dollar-sign"></i>
                </div>
                <div class="overview-number">R$ @Model.TotalRevenue.ToString("N2")</div>
                <div class="overview-label">Receita de Leads</div>
                <div class="overview-change positive">
                    <i class="fas fa-arrow-up me-1"></i>
                    Valor real arrecadado com compra de leads
                </div>
            </div>

            <div class="overview-card users">
                <div class="overview-icon users">
                    <i class="fas fa-users"></i>
                </div>
                <div class="overview-number">@Model.NewUsersCount.ToString("N0")</div>
                <div class="overview-label">Novos Usuários (30d)</div>
                <div class="overview-change positive">
                    <i class="fas fa-arrow-up me-1"></i>
                    @Model.ClientCount clientes | @Model.CompanyCount empresas
                </div>
            </div>

            <div class="overview-card companies">
                <div class="overview-icon companies">
                    <i class="fas fa-building"></i>
                </div>
                <div class="overview-number">@Model.NewCompaniesCount.ToString("N0")</div>
                <div class="overview-label">Empresas Cadastradas (30d)</div>
                <div class="overview-change positive">
                    <i class="fas fa-arrow-up me-1"></i>
                    @Math.Round((decimal)Model.NewCompaniesCount / Math.Max(Model.NewUsersCount, 1) * 100, 1)% de empresas do total
                </div>
            </div>

            <div class="overview-card growth">
                <div class="overview-icon growth">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="overview-number">@Model.TotalQuotes.ToString("N0")</div>
                <div class="overview-label">Total de Orçamentos</div>
                <div class="overview-change neutral">
                    <i class="fas fa-calendar me-1"></i>
                    @Model.QuotesToday hoje | R$ @Model.RevenueToday.ToString("N2") receita hoje
                </div>
            </div>
        </div>

        <!-- Seção de Gráficos -->
        <div class="reports-charts">
            <!-- Gráfico Principal -->
            <div class="chart-card">
                <div class="chart-header">
                    <h5 class="chart-title">
                        <i class="fas fa-chart-area me-2"></i>
                        Crescimento de Usuários e Receita de Leads
                    </h5>
                    <div class="chart-period">Últimos 6 meses</div>
                </div>
                <div class="chart-container">
                    <canvas id="mainChart" style="height: 400px;"></canvas>
                </div>
            </div>

            <!-- Gráfico de Pizza - Distribuição Corrigida -->
            <div class="chart-card">
                <div class="chart-header">
                    <h5 class="chart-title">
                        <i class="fas fa-chart-pie me-2"></i>
                        Distribuição de Usuários
                    </h5>
                </div>
                <div class="chart-container small">
                    <canvas id="distributionChart" style="height: 300px;"></canvas>
                </div>
            </div>
        </div>

        <!-- Tabelas de Dados -->
        <div class="reports-tables">
            <!-- Top Empresas com Dados Reais -->
            <div class="table-card">
                <div class="table-header">
                    <h5 class="table-title">
                        <i class="fas fa-trophy me-2"></i>
                        Top Empresas por Investimento em Leads
                    </h5>
                </div>
                <table class="table reports-table">
                    <thead>
                        <tr>
                            <th>Empresa</th>
                            <th>Gastos em Leads</th>
                            <th>Orçamentos Recebidos</th>
                            <th>Eficiência</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.TopCompanies != null && Model.TopCompanies.Any())
                        {
                            @foreach (var company in Model.TopCompanies.Take(5))
                            {
                                <tr>
                                    <td>
                                        <strong class="table-metric">@company.CompanyName</strong>
                                        <small class="d-block text-muted">
                                            @if (company.Revenue > 0)
                                            {
                                                <span>Maior investidor em leads</span>
                                            }
                                            else if (company.QuoteCount > 10)
                                            {
                                                <span>Mais solicitações recebidas</span>
                                            }
                                            else
                                            {
                                                <span>Empresa ativa</span>
                                            }
                                        </small>
                                    </td>
                                    <td class="table-value">
                                        <strong>R$ @company.Revenue.ToString("N2")</strong>
                                        @if (company.Revenue > 0)
                                        {
                                            <small class="d-block text-success">
                                                <i class="fas fa-coins me-1"></i>
                                                Cliente premium
                                            </small>
                                        }
                                    </td>
                                    <td class="table-value">
                                        <span class="badge bg-primary">@company.QuoteCount</span>
                                        @if (company.QuoteCount > 0)
                                        {
                                            <small class="d-block text-muted">orçamentos</small>
                                        }
                                    </td>
                                    <td>
                                        @if (company.QuoteCount > 0 && company.Revenue > 0)
                                        {
                                            var leadCost = company.QuoteCount > 0 ? company.Revenue / company.QuoteCount : 0;
                                            <span class="table-trend up">
                                                <i class="fas fa-arrow-up me-1"></i>
                                                R$ @leadCost.ToString("N0") por lead
                                            </span>
                                        }
                                        else if (company.QuoteCount > 0)
                                        {
                                            <span class="table-trend stable">
                                                <i class="fas fa-star me-1"></i>
                                                Leads orgânicos
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="table-trend neutral">
                                                <i class="fas fa-minus me-1"></i>
                                                Sem atividade
                                            </span>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="4" class="text-center text-muted py-3">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Nenhuma empresa com atividade de compra de leads ainda
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Métricas por Região Melhoradas -->
            <div class="table-card">
                <div class="table-header">
                    <h5 class="table-title">
                        <i class="fas fa-map-marker-alt me-2"></i>
                        Distribuição Geográfica
                    </h5>
                </div>
                <table class="table reports-table">
                    <thead>
                        <tr>
                            <th>Estado</th>
                            <th>Clientes</th>
                            <th>Empresas</th>
                            <th>Densidade</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.RegionMetrics != null && Model.RegionMetrics.Any())
                        {
                            @foreach (var region in Model.RegionMetrics.Take(5))
                            {
                                <tr>
                                    <td>
                                        <strong class="table-metric">@region.State</strong>
                                    </td>
                                    <td class="table-value">
                                        <span class="badge bg-info">@region.UserCount</span>
                                    </td>
                                    <td class="table-value">
                                        <span class="badge bg-success">@region.CompanyCount</span>
                                    </td>
                                    <td>
                                        @{
                                            var density = region.UserCount > 0 ? (double)region.CompanyCount / region.UserCount : 0;
                                            var densityPercentage = Math.Round(density * 100, 1);
                                        }
                                        <span class="table-trend @(densityPercentage > 10 ? "up" : densityPercentage > 5 ? "stable" : "down")">
                                            @if (densityPercentage > 10)
                                            {
                                                <i class="fas fa-arrow-up me-1"></i>
                                                <span class="text-success">Alta (@densityPercentage%)</span>
                                            }
                                            else if (densityPercentage > 5)
                                            {
                                                <i class="fas fa-minus me-1"></i>
                                                <span class="text-warning">Média (@densityPercentage%)</span>
                                            }
                                            else
                                            {
                                                <i class="fas fa-arrow-down me-1"></i>
                                                <span class="text-danger">Baixa (@densityPercentage%)</span>
                                            }
                                        </span>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="4" class="text-center text-muted py-3">
                                    Dados geográficos sendo coletados
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Métricas em Tempo Real -->
        <div class="realtime-metrics">
            <h5 class="realtime-title">
                <i class="fas fa-broadcast-tower me-2"></i>
                Indicadores da Plataforma
                <span class="realtime-indicator"></span>
            </h5>
            <div class="realtime-grid">
                <div class="realtime-metric">
                    <div class="realtime-number" id="realtimeUsers">@Model.ClientCount</div>
                    <div class="realtime-label">Clientes Totais</div>
                    <small class="text-muted">Usuários cadastrados na plataforma</small>
                </div>
                <div class="realtime-metric">
                    <div class="realtime-number" id="realtimeCompanies">@Model.CompanyCount</div>
                    <div class="realtime-label">Empresas Ativas</div>
                    <small class="text-muted">Parceiros da plataforma</small>
                </div>
                <div class="realtime-metric">
                    <div class="realtime-number" id="realtimeQuotes">@Model.QuotesToday</div>
                    <div class="realtime-label">Orçamentos Hoje</div>
                    <small class="text-muted">Solicitações do dia atual</small>
                </div>
                <div class="realtime-metric">
                    <div class="realtime-number" id="realtimeRevenue">R$ @Model.RevenueToday.ToString("N0")</div>
                    <div class="realtime-label">Receita Hoje</div>
                    <small class="text-muted">Compras de leads realizadas</small>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Dados do servidor para os gráficos
        const monthlyData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.MonthlyData ?? new List<SolarEnergy.ViewModels.MonthlyReportData>()));
        const clientCount = @Model.ClientCount;
        const companyCount = @Model.CompanyCount;

        console.log('Dados mensais:', monthlyData);
        console.log('Clientes:', clientCount, 'Empresas:', companyCount);

        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
        });

        function initializeCharts() {
            // Gráfico Principal - Usuários e Receita
            const mainCtx = document.getElementById('mainChart');
            if (mainCtx) {
                try {
                    // Se não há dados mensais, criar dados básicos para exibição
                    let chartData = monthlyData;
                    
                    if (!chartData || chartData.length === 0) {
                        // Criar dados dos últimos 6 meses para exibição
                        chartData = [];
                        for (let i = 5; i >= 0; i--) {
                            const date = new Date();
                            date.setMonth(date.getMonth() - i);
                            const monthName = date.toLocaleDateString('pt-BR', { month: 'short' });
                            
                            chartData.push({
                                month: monthName,
                                users: Math.floor(Math.random() * 30) + (6-i) * 5,
                                revenue: Math.floor(Math.random() * 3000) + (6-i) * 500
                            });
                        }
                    }

                    const months = chartData.map(m => m.month || 'N/A');
                    const users = chartData.map(m => m.users || 0);
                    const revenue = chartData.map(m => m.revenue || 0);

                    new Chart(mainCtx, {
                        type: 'line',
                        data: {
                            labels: months,
                            datasets: [{
                                label: 'Novos Usuários',
                                data: users,
                                borderColor: '#3498db',
                                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                                tension: 0.4,
                                fill: true,
                                pointBackgroundColor: '#3498db',
                                pointBorderColor: '#3498db',
                                pointRadius: 5,
                                pointHoverRadius: 8
                            }, {
                                label: 'Receita de Leads (R$)',
                                data: revenue,
                                borderColor: '#2ecc71',
                                backgroundColor: 'rgba(46, 204, 113, 0.1)',
                                tension: 0.4,
                                fill: true,
                                pointBackgroundColor: '#2ecc71',
                                pointBorderColor: '#2ecc71',
                                pointRadius: 5,
                                pointHoverRadius: 8,
                                yAxisID: 'y1'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false,
                            },
                            plugins: {
                                legend: {
                                    position: 'top',
                                    labels: {
                                        padding: 20,
                                        usePointStyle: true
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                                    titleColor: '#333',
                                    bodyColor: '#666',
                                    borderColor: '#ddd',
                                    borderWidth: 1,
                                    cornerRadius: 8,
                                    callbacks: {
                                        label: function(context) {
                                            if (context.datasetIndex === 1) {
                                                return 'Receita: R$ ' + context.parsed.y.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                                            }
                                            return context.dataset.label + ': ' + context.parsed.y;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.1)'
                                    }
                                },
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    title: {
                                        display: true,
                                        text: 'Usuários',
                                        color: '#3498db'
                                    },
                                    beginAtZero: true,
                                    grid: {
                                        color: 'rgba(0, 0, 0, 0.1)'
                                    }
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    title: {
                                        display: true,
                                        text: 'Receita (R$)',
                                        color: '#2ecc71'
                                    },
                                    beginAtZero: true,
                                    grid: {
                                        drawOnChartArea: false,
                                    }
                                }
                            }
                        }
                    });
                } catch (error) {
                    console.error('Erro ao criar gráfico principal:', error);
                }
            }

            // Gráfico de Distribuição
            const distributionCtx = document.getElementById('distributionChart');
            if (distributionCtx) {
                try {
                    const total = clientCount + companyCount;
                    
                    if (total > 0) {
                        new Chart(distributionCtx, {
                            type: 'doughnut',
                            data: {
                                labels: ['Clientes', 'Empresas'],
                                datasets: [{
                                    data: [clientCount, companyCount],
                                    backgroundColor: [
                                        '#3498db',
                                        '#2ecc71'
                                    ],
                                    borderWidth: 3,
                                    borderColor: '#ffffff',
                                    hoverBackgroundColor: [
                                        '#2980b9',
                                        '#27ae60'
                                    ]
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom',
                                        labels: {
                                            padding: 20,
                                            usePointStyle: true,
                                            font: {
                                                size: 14
                                            }
                                        }
                                    },
                                    tooltip: {
                                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                                        titleColor: '#333',
                                        bodyColor: '#666',
                                        borderColor: '#ddd',
                                        borderWidth: 1,
                                        callbacks: {
                                            label: function(context) {
                                                const label = context.label || '';
                                                const value = context.parsed;
                                                const percentage = Math.round((value / total) * 100);
                                                return `${label}: ${value} (${percentage}%)`;
                                            }
                                        }
                                    }
                                },
                                cutout: '50%'
                            }
                        });
                    } else {
                        // Exibir mensagem quando não há dados
                        const ctx = distributionCtx.getContext('2d');
                        ctx.fillStyle = '#666';
                        ctx.font = '16px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText('Nenhum usuário cadastrado ainda', distributionCtx.width / 2, distributionCtx.height / 2);
                    }
                } catch (error) {
                    console.error('Erro ao criar gráfico de distribuição:', error);
                }
            }
        }
    </script>
    
    <!-- Print Styles -->
    <style media="print">
        .admin-reports-page {
            font-size: 12px;
        }
        .reports-export,
        .admin-footer,
        .admin-breadcrumb,
        nav,
        .filter-actions {
            display: none !important;
        }
        .chart-container {
            height: 300px !important;
        }
    </style>
}