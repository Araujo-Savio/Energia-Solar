@model SolarEnergy.ViewModels.AdminCompaniesViewModel
@{
    ViewData["Title"] = "Gerenciar Empresas";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["BreadcrumbItems"] = new List<dynamic>
    {
        new { Title = "Empresas", Url = "", IsActive = true }
    };
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin-companies.css" asp-append-version="true" />
}

<div class="admin-companies-page admin-fade-in">
    <div class="container-fluid px-4">
        <!-- Page Header -->
        <div class="admin-companies-header">
            <div class="companies-title">
                <i class="fas fa-building me-3 text-admin-success"></i>
                Gerenciar Empresas
            </div>
            <p class="companies-subtitle">
                Verifique e aprove empresas parceiras da plataforma Solar Energy
            </p>
        </div>

        <!-- Estatísticas das Empresas -->
        <div class="companies-stats">
            <div class="company-stat-card">
                <div class="company-stat-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="company-stat-number">@Model.VerifiedCompanies</div>
                <div class="company-stat-label">Verificadas</div>
            </div>
            <div class="company-stat-card pending">
                <div class="company-stat-icon pending">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="company-stat-number">@Model.PendingCompanies</div>
                <div class="company-stat-label">Pendentes</div>
            </div>
            <div class="company-stat-card rejected">
                <div class="company-stat-icon rejected">
                    <i class="fas fa-times-circle"></i>
                </div>
                <div class="company-stat-number">@Model.RejectedCompanies</div>
                <div class="company-stat-label">Rejeitadas</div>
            </div>
            <div class="company-stat-card total">
                <div class="company-stat-icon total">
                    <i class="fas fa-building"></i>
                </div>
                <div class="company-stat-number">@Model.TotalCompanies</div>
                <div class="company-stat-label">Total</div>
            </div>
        </div>

        <!-- Ações de Verificação -->
        @if (Model.PendingCompanies > 0)
        {
            <div class="companies-actions">
                <div class="actions-header">
                    <h5 class="actions-title">
                        <i class="fas fa-tasks me-2"></i>
                        Ações em Massa
                    </h5>
                    <div class="bulk-actions" style="display: none;">
                        <button type="button" class="bulk-action-btn approve" onclick="bulkApproveCompanies()">
                            <i class="fas fa-check me-1"></i>
                            Aprovar Selecionadas
                        </button>
                        <button type="button" class="bulk-action-btn reject" onclick="bulkRejectCompanies()">
                            <i class="fas fa-times me-1"></i>
                            Rejeitar Selecionadas
                        </button>
                    </div>
                </div>
                <p class="text-muted mb-0">
                    <i class="fas fa-info-circle me-1"></i>
                    Selecione empresas na lista abaixo para usar as Ações em massa
                </p>
            </div>
        }

        <!-- Filtros Modernos -->
        <div class="companies-filters-modern">
            <div class="filter-container">
                <!-- Header dos Filtros -->
                <div class="filter-header">
                    <div class="filter-title">
                        <i class="fas fa-filter me-2 text-solar-orange"></i>
                        <span>Filtros Avançados</span>
                    </div>
                    <div class="filter-actions">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearAllFilters()">
                            <i class="fas fa-times me-1"></i>Limpar Filtros
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="collapse" data-bs-target="#advancedFilters">
                            <i class="fas fa-cog me-1"></i>Avançado
                        </button>
                    </div>
                </div>

                <!-- Filtros Principais -->
                <form method="get" id="filterForm" class="filter-form">
                    <div class="primary-filters">
                        <!-- Status Quick Tabs -->
                        <div class="status-tabs">
                            <label class="filter-section-label">Status da Empresa</label>
                            <div class="tab-buttons">
                                <input type="radio" name="status" value="" id="status-all" 
                                       @(ViewBag.StatusFilter == "" || ViewBag.StatusFilter == null ? "checked" : "") />
                                <label for="status-all" class="tab-button">
                                    <i class="fas fa-list-ul"></i>
                                    <span>Todas</span>
                                    <span class="tab-count">@Model.TotalCompanies</span>
                                </label>

                                <input type="radio" name="status" value="pending" id="status-pending"
                                       @(ViewBag.StatusFilter == "pending" ? "checked" : "") />
                                <label for="status-pending" class="tab-button pending">
                                    <i class="fas fa-clock"></i>
                                    <span>Pendentes</span>
                                    <span class="tab-count">@Model.PendingCompanies</span>
                                </label>

                                <input type="radio" name="status" value="verified" id="status-verified"
                                       @(ViewBag.StatusFilter == "verified" ? "checked" : "") />
                                <label for="status-verified" class="tab-button verified">
                                    <i class="fas fa-check-circle"></i>
                                    <span>Verificadas</span>
                                    <span class="tab-count">@Model.VerifiedCompanies</span>
                                </label>

                                <input type="radio" name="status" value="rejected" id="status-rejected"
                                       @(ViewBag.StatusFilter == "rejected" ? "checked" : "") />
                                <label for="status-rejected" class="tab-button rejected">
                                    <i class="fas fa-times-circle"></i>
                                    <span>Rejeitadas</span>
                                    <span class="tab-count">@Model.RejectedCompanies</span>
                                </label>
                            </div>
                        </div>

                        <!-- Busca Principal -->
                        <div class="search-group">
                            <label class="filter-section-label">Buscar Empresa</label>
                            <div class="search-input-group">
                                <div class="search-input-wrapper">
                                    <i class="fas fa-search search-icon"></i>
                                    <input type="text" name="search" value="@ViewBag.SearchTerm" 
                                           class="search-input" 
                                           placeholder="Nome da empresa, CNPJ, e-mail..."
                                           autocomplete="off" />
                                    @if (!string.IsNullOrEmpty(ViewBag.SearchTerm?.ToString()))
                                    {
                                        <button type="button" class="clear-search" onclick="clearSearch()">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    }
                                </div>
                                <button type="submit" class="search-submit">
                                    <i class="fas fa-search"></i>
                                    <span class="d-none d-md-inline">Buscar</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Filtros Avançados (Colapsáveis) -->
                    <div class="collapse @((!string.IsNullOrEmpty(ViewBag.StateFilter?.ToString())) ? "show" : "")" id="advancedFilters">
                        <div class="advanced-filters">
                            <div class="advanced-filter-grid">
                                <!-- Localização -->
                                <div class="filter-group-modern">
                                    <label class="filter-label-modern">
                                        <i class="fas fa-map-marker-alt me-2"></i>Estado
                                    </label>
                                    <select name="state" class="filter-select-modern">
                                        <option value="">Todos os estados</option>
                                        <option value="AC" selected="@(ViewBag.StateFilter?.ToString() == "AC")">Acre</option>
                                        <option value="AL" selected="@(ViewBag.StateFilter?.ToString() == "AL")">Alagoas</option>
                                        <option value="AP" selected="@(ViewBag.StateFilter?.ToString() == "AP")">Amapá</option>
                                        <option value="AM" selected="@(ViewBag.StateFilter?.ToString() == "AM")">Amazonas</option>
                                        <option value="BA" selected="@(ViewBag.StateFilter?.ToString() == "BA")">Bahia</option>
                                        <option value="CE" selected="@(ViewBag.StateFilter?.ToString() == "CE")">Ceará</option>
                                        <option value="DF" selected="@(ViewBag.StateFilter?.ToString() == "DF")">Distrito Federal</option>
                                        <option value="ES" selected="@(ViewBag.StateFilter?.ToString() == "ES")">Espírito Santo</option>
                                        <option value="GO" selected="@(ViewBag.StateFilter?.ToString() == "GO")">Goiás</option>
                                        <option value="MA" selected="@(ViewBag.StateFilter?.ToString() == "MA")">Maranhão</option>
                                        <option value="MT" selected="@(ViewBag.StateFilter?.ToString() == "MT")">Mato Grosso</option>
                                        <option value="MS" selected="@(ViewBag.StateFilter?.ToString() == "MS")">Mato Grosso do Sul</option>
                                        <option value="MG" selected="@(ViewBag.StateFilter?.ToString() == "MG")">Minas Gerais</option>
                                        <option value="PA" selected="@(ViewBag.StateFilter?.ToString() == "PA")">Pará</option>
                                        <option value="PB" selected="@(ViewBag.StateFilter?.ToString() == "PB")">Paraíba</option>
                                        <option value="PR" selected="@(ViewBag.StateFilter?.ToString() == "PR")">Paraná</option>
                                        <option value="PE" selected="@(ViewBag.StateFilter?.ToString() == "PE")">Pernambuco</option>
                                        <option value="PI" selected="@(ViewBag.StateFilter?.ToString() == "PI")">Piauí</option>
                                        <option value="RJ" selected="@(ViewBag.StateFilter?.ToString() == "RJ")">Rio de Janeiro</option>
                                        <option value="RN" selected="@(ViewBag.StateFilter?.ToString() == "RN")">Rio Grande do Norte</option>
                                        <option value="RS" selected="@(ViewBag.StateFilter?.ToString() == "RS")">Rio Grande do Sul</option>
                                        <option value="RO" selected="@(ViewBag.StateFilter?.ToString() == "RO")">Rondônia</option>
                                        <option value="RR" selected="@(ViewBag.StateFilter?.ToString() == "RR")">Roraima</option>
                                        <option value="SC" selected="@(ViewBag.StateFilter?.ToString() == "SC")">Santa Catarina</option>
                                        <option value="SP" selected="@(ViewBag.StateFilter?.ToString() == "SP")">São Paulo</option>
                                        <option value="SE" selected="@(ViewBag.StateFilter?.ToString() == "SE")">Sergipe</option>
                                        <option value="TO" selected="@(ViewBag.StateFilter?.ToString() == "TO")">Tocantins</option>
                                    </select>
                                </div>

                                <!-- Data de Cadastro -->
                                <div class="filter-group-modern">
                                    <label class="filter-label-modern">
                                        <i class="fas fa-calendar me-2"></i>Data de Cadastro
                                    </label>
                                    <select name="dateRange" class="filter-select-modern">
                                        <option value="">Qualquer período</option>
                                        <option value="today" selected="@(ViewBag.DateRange?.ToString() == "today")">Hoje</option>
                                        <option value="week" selected="@(ViewBag.DateRange?.ToString() == "week")">Última semana</option>
                                        <option value="month" selected="@(ViewBag.DateRange?.ToString() == "month")">Último mês</option>
                                        <option value="quarter" selected="@(ViewBag.DateRange?.ToString() == "quarter")">Último trimestre</option>
                                        <option value="year" selected="@(ViewBag.DateRange?.ToString() == "year")">Último ano</option>
                                    </select>
                                </div>

                                <!-- Avaliação -->
                                <div class="filter-group-modern">
                                    <label class="filter-label-modern">
                                        <i class="fas fa-star me-2"></i>Avaliação Mínima
                                    </label>
                                    <select name="rating" class="filter-select-modern">
                                        <option value="">Qualquer avaliação</option>
                                        <option value="5" selected="@(ViewBag.RatingFilter?.ToString() == "5")">????? (5 estrelas)</option>
                                        <option value="4" selected="@(ViewBag.RatingFilter?.ToString() == "4")">???? (4+ estrelas)</option>
                                        <option value="3" selected="@(ViewBag.RatingFilter?.ToString() == "3")">??? (3+ estrelas)</option>
                                        <option value="2" selected="@(ViewBag.RatingFilter?.ToString() == "2")">?? (2+ estrelas)</option>
                                        <option value="1" selected="@(ViewBag.RatingFilter?.ToString() == "1")">? (1+ estrelas)</option>
                                    </select>
                                </div>

                                <!-- Ordenação -->
                                <div class="filter-group-modern">
                                    <label class="filter-label-modern">
                                        <i class="fas fa-sort me-2"></i>Ordenar por
                                    </label>
                                    <select name="sortBy" class="filter-select-modern">
                                        <option value="newest" selected="@(ViewBag.SortBy?.ToString() == "newest")">Mais recentes</option>
                                        <option value="oldest" selected="@(ViewBag.SortBy?.ToString() == "oldest")">Mais antigas</option>
                                        <option value="name" selected="@(ViewBag.SortBy?.ToString() == "name")">Nome A-Z</option>
                                        <option value="rating" selected="@(ViewBag.SortBy?.ToString() == "rating")">Melhor avaliadas</option>
                                        <option value="location" selected="@(ViewBag.SortBy?.ToString() == "location")">Localização</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Botões de Ação dos Filtros Avançados -->
                            <div class="advanced-filter-actions">
                                <button type="submit" class="btn btn-solar-orange">
                                    <i class="fas fa-filter me-2"></i>Aplicar Filtros
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="resetAdvancedFilters()">
                                    <i class="fas fa-undo me-2"></i>Redefinir
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Resultados e Filtros Ativos -->
                    <div class="filter-results">
                        <div class="results-info">
                            <span class="results-count">
                                <strong>@Model.Companies.Count()</strong> empresas encontradas
                                @if (Model.TotalCompanies != Model.Companies.Count())
                                {
                                    <span class="text-muted">de @Model.TotalCompanies total</span>
                                }
                            </span>
                        </div>

                        <!-- Tags de Filtros Ativos -->
                        <div class="active-filters">
                            @if (!string.IsNullOrEmpty(ViewBag.SearchTerm?.ToString()))
                            {
                                <span class="filter-tag">
                                    <i class="fas fa-search me-1"></i>
                                    "@ViewBag.SearchTerm"
                                    <button type="button" onclick="removeFilter('search')" class="remove-filter">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </span>
                            }
                            @if (!string.IsNullOrEmpty(ViewBag.StatusFilter?.ToString()) && ViewBag.StatusFilter?.ToString() != "")
                            {
                                <span class="filter-tag">
                                    <i class="fas fa-check-circle me-1"></i>
                                    Status: @(ViewBag.StatusFilter == "verified" ? "Verificadas" : ViewBag.StatusFilter == "pending" ? "Pendentes" : "Rejeitadas")
                                    <button type="button" onclick="removeFilter('status')" class="remove-filter">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </span>
                            }
                            @if (!string.IsNullOrEmpty(ViewBag.StateFilter?.ToString()))
                            {
                                <span class="filter-tag">
                                    <i class="fas fa-map-marker-alt me-1"></i>
                                    Estado: @ViewBag.StateFilter
                                    <button type="button" onclick="removeFilter('state')" class="remove-filter">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </span>
                            }
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Lista de Empresas -->
        <div class="companies-container">
            <div class="companies-header">
                <h5 class="table-title">
                    <i class="fas fa-list me-2"></i>
                    Lista de Empresas
                </h5>
                <div class="companies-view-toggle">
                    <button class="view-toggle-btn active" data-view="grid" title="Visualização em Grade">
                        <i class="fas fa-th"></i>
                    </button>
                    <button class="view-toggle-btn" data-view="list" title="Visualização em Lista">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
            </div>

            @if (Model.Companies != null && Model.Companies.Any())
            {
                <!-- Grid View -->
                <div class="companies-grid" id="gridView">
                    @foreach (var company in Model.Companies)
                    {
                        <div class="company-card admin-slide-up">
                            <div class="company-card-header">
                                <div class="company-logo">
                                    @(company.CompanyName?.Substring(0, 1).ToUpper() ?? "E")
                                </div>
                                <h6 class="company-name">@company.CompanyName</h6>
                                <p class="company-location">
                                    <i class="fas fa-map-marker-alt me-1"></i>
                                    @company.City, @company.State
                                </p>
                                <span class="company-status-badge @(company.IsVerified ? "verified" : company.IsRejected ? "rejected" : "pending")">
                                    @(company.IsVerified ? "Verificada" : company.IsRejected ? "Rejeitada" : "Pendente")
                                </span>
                                
                                @if (!company.IsVerified && !company.IsRejected)
                                {
                                    <input type="checkbox" name="selectedCompanies" value="@company.Id" 
                                           class="form-check-input item-checkbox position-absolute" 
                                           style="top: 1rem; left: 1rem;">
                                }
                            </div>
                            
                            <div class="company-card-body">
                                <div class="company-info">
                                    <div class="company-info-item">
                                        <i class="fas fa-envelope"></i>
                                        <span>@company.Email</span>
                                    </div>
                                    <div class="company-info-item">
                                        <i class="fas fa-phone"></i>
                                        <span>@(company.Phone ?? "Não informado")</span>
                                    </div>
                                    <div class="company-info-item">
                                        <i class="fas fa-id-card"></i>
                                        <span>@(company.CNPJ ?? "CNPJ não informado")</span>
                                    </div>
                                    @if (company.AverageRating.HasValue)
                                    {
                                        <div class="company-rating">
                                            <div class="rating-stars">
                                                @for (int i = 1; i <= 5; i++)
                                                {
                                                    <i class="fas fa-star @(i <= company.AverageRating ? "" : "text-muted")"></i>
                                                }
                                            </div>
                                            <span class="rating-text">@company.AverageRating.Value.ToString("N1") (@company.ReviewCount avaliações)</span>
                                        </div>
                                    }
                                </div>
                                
                                <div class="company-card-actions">
                                    <button type="button" class="company-action-btn view" 
                                            onclick="viewCompanyDetails('@company.Id')">
                                        <i class="fas fa-eye me-1"></i>
                                        Ver Detalhes
                                    </button>
                                    
                                    @if (!company.IsVerified && !company.IsRejected)
                                    {
                                        <button type="button" class="company-action-btn approve" 
                                                onclick="approveCompany('@company.Id')">
                                            <i class="fas fa-check me-1"></i>
                                            Aprovar
                                        </button>
                                        <button type="button" class="company-action-btn reject" 
                                                onclick="rejectCompany('@company.Id')">
                                            <i class="fas fa-times me-1"></i>
                                            Rejeitar
                                        </button>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <!-- List View (Initially Hidden) -->
                <div id="listView" style="display: none;">
                    <table class="table companies-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;">
                                    <input type="checkbox" id="select-all" class="form-check-input">
                                </th>
                                <th>Empresa</th>
                                <th>Localização</th>
                                <th>Status</th>
                                <th>Verificação</th>
                                <th>Avaliação</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var company in Model.Companies)
                            {
                                <tr>
                                    <td>
                                        @if (!company.IsVerified && !company.IsRejected)
                                        {
                                            <input type="checkbox" name="selectedCompanies" value="@company.Id" 
                                                   class="form-check-input item-checkbox">
                                        }
                                    </td>
                                    <td>
                                        <div class="table-company-info">
                                            <div class="table-company-logo">
                                                @(company.CompanyName?.Substring(0, 1).ToUpper() ?? "E")
                                            </div>
                                            <div class="table-company-details">
                                                <div class="table-company-name">@company.CompanyName</div>
                                                <div class="table-company-email">@company.Email</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        @company.City, @company.State
                                    </td>
                                    <td>
                                        <span class="company-status-badge @(company.IsVerified ? "verified" : company.IsRejected ? "rejected" : "pending")">
                                            @(company.IsVerified ? "Verificada" : company.IsRejected ? "Rejeitada" : "Pendente")
                                        </span>
                                    </td>
                                    <td>
                                        <div class="verification-timeline">
                                            @if (company.IsVerified)
                                            {
                                                <span class="text-success">
                                                    <i class="fas fa-check-circle me-1"></i>
                                                    Verificada
                                                </span>
                                                @if (company.VerificationDate.HasValue)
                                                {
                                                    <br><small class="verification-date">@company.VerificationDate.Value.ToString("dd/MM/yyyy")</small>
                                                }
                                            }
                                            else if (company.IsRejected)
                                            {
                                                <span class="text-danger">
                                                    <i class="fas fa-times-circle me-1"></i>
                                                    Rejeitada
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="text-warning">
                                                    <i class="fas fa-clock me-1"></i>
                                                    Aguardando
                                                </span>
                                            }
                                        </div>
                                    </td>
                                    <td>
                                        @if (company.AverageRating.HasValue)
                                        {
                                            <div class="rating-stars small">
                                                @for (int i = 1; i <= 5; i++)
                                                {
                                                    <i class="fas fa-star @(i <= company.AverageRating ? "" : "text-muted")"></i>
                                                }
                                            </div>
                                            <small>@company.AverageRating.Value.ToString("N1") (@company.ReviewCount)</small>
                                        }
                                        else
                                        {
                                            <small class="text-muted">Sem avaliações</small>
                                        }
                                    </td>
                                    <td>
                                        <div class="user-actions">
                                            <button type="button" class="action-btn view" 
                                                    onclick="viewCompanyDetails('@company.Id')" title="Ver Detalhes">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            
                                            @if (!company.IsVerified && !company.IsRejected)
                                            {
                                                <button type="button" class="action-btn edit" 
                                                        onclick="approveCompany('@company.Id')" title="Aprovar">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                <button type="button" class="action-btn delete" 
                                                        onclick="rejectCompany('@company.Id')" title="Rejeitar">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="companies-empty">
                    <div class="empty-icon">
                        <i class="fas fa-building"></i>
                    </div>
                    <h4>Nenhuma empresa encontrada</h4>
                    <p class="text-muted">Não há empresas que correspondam aos critérios de busca.</p>
                </div>
            }
        </div>
    </div>
</div>

<!-- Modal de Detalhes da Empresa -->
<div class="modal fade verification-modal" id="companyDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-building me-2"></i>
                    Detalhes da Empresa
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="companyDetailsContent">
                <!-- Conteúdo será carregado via AJAX -->
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Toggle between grid and list view
        document.querySelectorAll('.view-toggle-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const view = this.getAttribute('data-view');
                
                // Update active state
                document.querySelectorAll('.view-toggle-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // Show/hide views
                if (view === 'grid') {
                    document.getElementById('gridView').style.display = 'grid';
                    document.getElementById('listView').style.display = 'none';
                } else {
                    document.getElementById('gridView').style.display = 'none';
                    document.getElementById('listView').style.display = 'block';
                }
            });
        });

        // Auto-submit form when status changes
        document.querySelectorAll('input[name="status"]').forEach(radio => {
            radio.addEventListener('change', function() {
                // Add loading state
                document.getElementById('filterForm').classList.add('loading');
                
                // Submit form
                setTimeout(() => {
                    document.getElementById('filterForm').submit();
                }, 200);
            });
        });

        // Search input enhancements
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.querySelector('.search-input');
            const searchForm = document.getElementById('filterForm');

            // Auto-submit search with debouncing
            let searchTimeout;
            searchInput?.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    if (this.value.length >= 3 || this.value.length === 0) {
                        searchForm.submit();
                    }
                }, 500);
            });

            // Handle Enter key
            searchInput?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    clearTimeout(searchTimeout);
                    searchForm.submit();
                }
            });
        });

        // Filter functions
        function clearSearch() {
            const searchInput = document.querySelector('.search-input');
            searchInput.value = '';
            document.getElementById('filterForm').submit();
        }

        function clearAllFilters() {
            const form = document.getElementById('filterForm');
            const inputs = form.querySelectorAll('input:not([type="radio"]), select');
            
            // Clear all inputs
            inputs.forEach(input => {
                if (input.type === 'text' || input.tagName === 'SELECT') {
                    input.value = '';
                }
            });

            // Reset status to "all"
            document.getElementById('status-all').checked = true;

            form.submit();
        }

        function resetAdvancedFilters() {
            const advancedInputs = document.querySelectorAll('#advancedFilters select');
            advancedInputs.forEach(select => {
                select.value = '';
            });
            
            document.getElementById('filterForm').submit();
        }

        function removeFilter(filterType) {
            const form = document.getElementById('filterForm');
            
            switch(filterType) {
                case 'search':
                    document.querySelector('input[name="search"]').value = '';
                    break;
                case 'status':
                    document.getElementById('status-all').checked = true;
                    break;
                case 'state':
                    document.querySelector('select[name="state"]').value = '';
                    break;
            }
            
            form.submit();
        }

        // Filter by status (for backward compatibility)
        function filterByStatus(status) {
            const form = document.getElementById('filterForm');
            const statusRadio = document.querySelector(`input[name="status"][value="${status}"]`);
            if (statusRadio) {
                statusRadio.checked = true;
                form.submit();
            }
        }

        // View company details
        async function viewCompanyDetails(companyId) {
            try {
                const response = await fetch(`@Url.Action("GetCompanyDetails", "Admin")?id=${companyId}`);
                const html = await response.text();
                
                document.getElementById('companyDetailsContent').innerHTML = html;
                new bootstrap.Modal(document.getElementById('companyDetailsModal')).show();
            } catch (error) {
                console.error('Error loading company details:', error);
                AdminJS.showNotification('error', 'Erro ao carregar detalhes da empresa');
            }
        }

        // Approve company
        function approveCompany(companyId) {
            AdminJS.showConfirmationModal(
                'Tem certeza que deseja aprovar esta empresa? Ela poderá receber leads após a aprovação.',
                () => updateCompanyStatus(companyId, 'approve')
            );
        }

        // Reject company
        function rejectCompany(companyId) {
            AdminJS.showConfirmationModal(
                'Tem certeza que deseja rejeitar esta empresa? Ela não poderá usar a plataforma.',
                () => updateCompanyStatus(companyId, 'reject')
            );
        }

        // Update company status
        async function updateCompanyStatus(companyId, action) {
            try {
                const formData = new FormData();
                formData.append('companyId', companyId);
                formData.append('action', action);
                formData.append('__RequestVerificationToken', $('input[name="__RequestVerificationToken"]').val());

                const response = await fetch('@Url.Action("UpdateCompanyStatus", "Admin")', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    window.location.reload();
                } else {
                    throw new Error('Network response was not ok');
                }
            } catch (error) {
                console.error('Error updating company status:', error);
                AdminJS.showNotification('error', 'Erro ao atualizar status da empresa');
            }
        }

        // Bulk operations
        function bulkApproveCompanies() {
            const selectedCompanies = Array.from(document.querySelectorAll('.item-checkbox:checked')).map(cb => cb.value);
            if (selectedCompanies.length === 0) {
                AdminJS.showNotification('warning', 'Selecione ao menos uma empresa');
                return;
            }

            AdminJS.showConfirmationModal(
                `Tem certeza que deseja aprovar ${selectedCompanies.length} empresa(s) selecionada(s)?`,
                () => bulkUpdateCompanies(selectedCompanies, 'approve')
            );
        }

        function bulkRejectCompanies() {
            const selectedCompanies = Array.from(document.querySelectorAll('.item-checkbox:checked')).map(cb => cb.value);
            if (selectedCompanies.length === 0) {
                AdminJS.showNotification('warning', 'Selecione ao menos uma empresa');
                return;
            }

            AdminJS.showConfirmationModal(
                `Tem certeza que deseja rejeitar ${selectedCompanies.length} empresa(s) selecionada(s)?`,
                () => bulkUpdateCompanies(selectedCompanies, 'reject')
            );
        }

        async function bulkUpdateCompanies(companyIds, action) {
            try {
                const formData = new FormData();
                companyIds.forEach(id => formData.append('companyIds', id));
                formData.append('action', action);
                formData.append('__RequestVerificationToken', $('input[name="__RequestVerificationToken"]').val());

                const response = await fetch('@Url.Action("BulkUpdateCompanies", "Admin")', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    window.location.reload();
                } else {
                    throw new Error('Network response was not ok');
                }
            } catch (error) {
                console.error('Error in bulk operation:', error);
                AdminJS.showNotification('error', 'Erro na operação em massa');
            }
        }

        // Enhanced UX features
        document.addEventListener('DOMContentLoaded', function() {
            // Animate filter tags on load
            const filterTags = document.querySelectorAll('.filter-tag');
            filterTags.forEach((tag, index) => {
                tag.style.opacity = '0';
                tag.style.transform = 'translateY(10px)';
                setTimeout(() => {
                    tag.style.transition = 'all 0.3s ease';
                    tag.style.opacity = '1';
                    tag.style.transform = 'translateY(0)';
                }, index * 100);
            });

            // Auto-expand advanced filters if any are active
            const hasAdvancedFilters = document.querySelector('select[name="state"]').value || 
                                     document.querySelector('select[name="dateRange"]').value || 
                                     document.querySelector('select[name="rating"]').value ||
                                     document.querySelector('select[name="sortBy"]').value !== 'newest';
            
            if (hasAdvancedFilters) {
                const advancedFilters = document.getElementById('advancedFilters');
                if (!advancedFilters.classList.contains('show')) {
                    new bootstrap.Collapse(advancedFilters, { show: true });
                }
            }

            // Add loading animation to form submissions
            const form = document.getElementById('filterForm');
            form.addEventListener('submit', function() {
                this.classList.add('loading');
            });
        });
    </script>
}