@model SolarEnergy.ViewModels.AdminReviewsPageViewModel
@{
    ViewData["Title"] = "Moderar Avaliações";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    ViewData["BreadcrumbItems"] = new List<dynamic>
    {
        new { Title = "Dashboard", Url = Url.Action("Dashboard", "Admin"), IsActive = false },
        new { Title = "Avaliações", Url = "", IsActive = true }
    };
}

<div class="admin-reviews admin-fade-in">
    <div class="container-fluid px-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-0 text-gray-800">
                    <i class="fas fa-star me-2 text-solar-orange"></i>
                    Moderar Avaliações
                </h1>
                <p class="mb-0 text-muted">Gerencie avaliações e comentários da plataforma</p>
            </div>
        </div>

        <!-- Filtros -->
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Filtros de Busca</h6>
            </div>
            <div class="card-body">
                <form method="get" class="row g-3">
                    @Html.AntiForgeryToken()
                    <div class="col-md-6">
                        <label for="search" class="form-label">Buscar por comentário ou nome</label>
                        <input type="text" class="form-control" id="search" name="search" value="@Model.SearchTerm" 
                               placeholder="Digite o texto do comentário ou nome...">
                    </div>
                    <div class="col-md-4">
                        <label for="rating" class="form-label">Filtrar por nota</label>
                        <select class="form-select" id="rating" name="rating">
                            <option value="">Todas as notas</option>
                            <option value="5" selected="@(Model.SelectedRating == 5)">????? (5 estrelas)</option>
                            <option value="4" selected="@(Model.SelectedRating == 4)">???? (4 estrelas)</option>
                            <option value="3" selected="@(Model.SelectedRating == 3)">??? (3 estrelas)</option>
                            <option value="2" selected="@(Model.SelectedRating == 2)">?? (2 estrelas)</option>
                            <option value="1" selected="@(Model.SelectedRating == 1)">? (1 estrela)</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search me-1"></i>Buscar
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Resultados -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-primary">
                    Avaliações Encontradas (@Model.TotalReviews)
                </h6>
                <div class="dropdown">
                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                            data-bs-toggle="dropdown">
                        <i class="fas fa-download me-1"></i>Exportar
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#"><i class="fas fa-file-excel me-2"></i>Excel</a></li>
                        <li><a class="dropdown-item" href="#"><i class="fas fa-file-pdf me-2"></i>PDF</a></li>
                    </ul>
                </div>
            </div>
            <div class="card-body p-0">
                @if (Model.Reviews.Any())
                {
                    <div class="review-list">
                        @foreach (var review in Model.Reviews)
                        {
                            <div class="review-item p-4 border-bottom" data-review-id="@review.Id">
                                <div class="row">
                                    <div class="col-md-8">
                                        <div class="d-flex align-items-start mb-3">
                                            <div class="avatar-sm me-3">
                                                <div class="avatar-title bg-soft-primary text-primary rounded-circle">
                                                    @review.ReviewerName.Substring(0, 1).ToUpper()
                                                </div>
                                            </div>
                                            <div class="flex-grow-1">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div>
                                                        <h6 class="mb-1">@review.ReviewerName</h6>
                                                        <p class="mb-0 text-muted small">
                                                            Avaliou <strong>@review.CompanyName</strong>
                                                        </p>
                                                    </div>
                                                    <div class="text-end">
                                                        @if (review.Rating.HasValue)
                                                        {
                                                            <div class="rating-display mb-1">
                                                                @for (int i = 1; i <= 5; i++)
                                                                {
                                                                    <i class="fas fa-star @(i <= review.Rating ? "text-warning" : "text-muted")"></i>
                                                                }
                                                                <span class="ms-2 badge bg-primary">@review.Rating/5</span>
                                                            </div>
                                                        }
                                                        <small class="text-muted">@review.CreatedAt.ToString("dd/MM/yyyy HH:mm")</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        @if (!string.IsNullOrEmpty(review.Comment))
                                        {
                                            <div class="comment-box bg-light p-3 rounded">
                                                <div class="d-flex align-items-start">
                                                    <i class="fas fa-quote-left text-muted me-2 mt-1"></i>
                                                    <div class="flex-grow-1">
                                                        <p class="mb-0">@review.Comment</p>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="comment-box bg-light p-3 rounded text-center">
                                                <span class="text-muted fst-italic">Avaliação apenas com nota, sem comentário</span>
                                            </div>
                                        }
                                    </div>
                                    
                                    <div class="col-md-4">
                                        <div class="admin-actions">
                                            <h6 class="text-muted mb-3">
                                                <i class="fas fa-tools me-1"></i>Ações Administrativas
                                            </h6>
                                            
                                            <div class="d-grid gap-2">
                                                <a href="@Url.Action("UserDetails", "Admin", new { id = review.ReviewerId })" 
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-user me-1"></i>Ver Avaliador
                                                </a>
                                                
                                                <a href="@Url.Action("UserDetails", "Admin", new { id = review.CompanyId })" 
                                                   class="btn btn-sm btn-outline-success">
                                                    <i class="fas fa-building me-1"></i>Ver Empresa
                                                </a>
                                                
                                                <button type="button" 
                                                        class="btn btn-sm btn-outline-danger"
                                                        onclick="deleteReview(@review.Id, '@review.ReviewerName')">
                                                    <i class="fas fa-trash me-1"></i>Remover Avaliação
                                                </button>
                                            </div>

                                            <!-- Informações adicionais -->
                                            <div class="mt-3 pt-3 border-top">
                                                <h6 class="text-muted mb-2">
                                                    <i class="fas fa-info-circle me-1"></i>Informações
                                                </h6>
                                                <div class="small">
                                                    <div class="mb-1">
                                                        <strong>ID:</strong> #@review.Id
                                                    </div>
                                                    <div class="mb-1">
                                                        <strong>Data:</strong> @review.CreatedAt.ToString("dd/MM/yyyy")
                                                    </div>
                                                    <div class="mb-1">
                                                        <strong>Hora:</strong> @review.CreatedAt.ToString("HH:mm")
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Paginação -->
                    @if (Model.TotalPages > 1)
                    {
                        <div class="card-footer">
                            <nav aria-label="Paginação de avaliações">
                                <ul class="pagination justify-content-center mb-0">
                                    <li class="page-item @(Model.CurrentPage <= 1 ? "disabled" : "")">
                                        <a class="page-link" href="@Url.Action("Reviews", "Admin", new { 
                                            search = Model.SearchTerm, 
                                            rating = Model.SelectedRating, 
                                            page = Model.CurrentPage - 1 
                                        })">
                                            Anterior
                                        </a>
                                    </li>

                                    @for (int i = Math.Max(1, Model.CurrentPage - 2); i <= Math.Min(Model.TotalPages, Model.CurrentPage + 2); i++)
                                    {
                                        <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                            <a class="page-link" href="@Url.Action("Reviews", "Admin", new { 
                                                search = Model.SearchTerm, 
                                                rating = Model.SelectedRating, 
                                                page = i 
                                            })">
                                                @i
                                            </a>
                                        </li>
                                    }

                                    <li class="page-item @(Model.CurrentPage >= Model.TotalPages ? "disabled" : "")">
                                        <a class="page-link" href="@Url.Action("Reviews", "Admin", new { 
                                            search = Model.SearchTerm, 
                                            rating = Model.SelectedRating, 
                                            page = Model.CurrentPage + 1 
                                        })">
                                            Próximo
                                        </a>
                                    </li>
                                </ul>
                            </nav>
                        </div>
                    }
                }
                else
                {
                    <div class="text-center py-5">
                        <i class="fas fa-star fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Nenhuma avaliação encontrada</h5>
                        <p class="text-muted">Tente ajustar os filtros de busca</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{ await Html.RenderPartialAsync("_ValidationScriptsPartial"); }
    <script>
        function deleteReview(reviewId, reviewerName) {
            if (confirm(`Tem certeza que deseja remover a avaliação de ${reviewerName}? Esta ação não pode ser desfeita.`)) {
                // Adiciona classe de loading ao item
                const reviewItem = $(`[data-review-id="${reviewId}"]`);
                reviewItem.addClass('loading');
                
                $.ajax({
                    url: '@Url.Action("DeleteReview", "Admin")',
                    type: 'POST',
                    data: {
                        id: reviewId,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            // Remove o item da lista com animação melhorada
                            reviewItem.removeClass('loading').addClass('removing');
                            
                            setTimeout(() => {
                                reviewItem.fadeOut(300, function() {
                                    $(this).remove();
                                    
                                    // Se não há mais avaliações na página, recarrega
                                    if ($('.review-item').length === 0) {
                                        location.reload();
                                    }
                                });
                            }, 200);
                            
                            // Mostra mensagem de sucesso
                            showAlert('success', response.message);
                        } else {
                            reviewItem.removeClass('loading');
                            showAlert('danger', 'Erro: ' + response.message);
                        }
                    },
                    error: function() {
                        reviewItem.removeClass('loading');
                        showAlert('danger', 'Erro ao processar a solicitação');
                    }
                });
            }
        }

        function showAlert(type, message) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            // Insere o alerta no topo da página
            $('.container-fluid').prepend(alertHtml);
            
            // Remove automaticamente após 5 segundos
            setTimeout(() => {
                $('.alert').fadeOut();
            }, 5000);
        }

        // Melhora o feedback visual dos botões
        $(document).ready(function() {
            $('.admin-actions .btn').on('click', function() {
                $(this).addClass('active');
                setTimeout(() => {
                    $(this).removeClass('active');
                }, 200);
            });
        });
    </script>
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin-reviews.css" asp-append-version="true" />
}
<style>
    .avatar-sm {
        height: 40px;
        width: 40px;
    }

    .avatar-title {
        align-items: center;
        display: flex;
        font-size: 16px;
        font-weight: 500;
        height: 100%;
        justify-content: center;
        width: 100%;
    }

    .bg-soft-primary {
        background-color: rgba(78, 115, 223, 0.18);
    }

    .admin-reviews .card {
        border: none;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15) !important;
    }

    .review-item {
        transition: background-color 0.2s ease;
    }

    .review-item:hover {
        background-color: rgba(0, 0, 0, 0.02);
    }

    .rating-display .fa-star {
        font-size: 0.9rem;
    }

    .comment-box {
        max-height: 150px;
        overflow-y: auto;
    }

    .admin-actions {
        background-color: #f8f9fc;
        border-radius: 0.35rem;
        padding: 1rem;
        height: fit-content;
    }

    .border-bottom:last-child {
        border-bottom: none !important;
    }

    .review-list {
        max-height: 800px;
        overflow-y: auto;
    }

    .fa-quote-left {
        font-size: 0.8rem;
        opacity: 0.6;
    }

    /* Estilos para animações de loading e remoção */
    .review-item.loading {
        opacity: 0.5;
    }

    .review-item.removing {
        opacity: 0;
        transform: translateY(-10px);
    }
</style>